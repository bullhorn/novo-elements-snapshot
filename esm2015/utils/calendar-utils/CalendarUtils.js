import * as dateFns from 'date-fns';
const WEEKEND_DAY_NUMBERS = [0, 6];
const DAYS_IN_WEEK = 7;
const HOURS_IN_DAY = 24;
const MINUTES_IN_HOUR = 60;
export var CalendarEventResponse;
(function (CalendarEventResponse) {
    CalendarEventResponse[CalendarEventResponse["Maybe"] = 0] = "Maybe";
    CalendarEventResponse[CalendarEventResponse["Accepted"] = 1] = "Accepted";
    CalendarEventResponse[CalendarEventResponse["Rejected"] = 2] = "Rejected";
})(CalendarEventResponse || (CalendarEventResponse = {}));
function getExcludedDays({ startDate, days, excluded }) {
    if (excluded.length < 1) {
        return 0;
    }
    let day = startDate.getDay();
    let reduce = 0;
    for (let i = 0; i < days; i++) {
        if (day === DAYS_IN_WEEK) {
            day = 0;
        }
        if (excluded.some((e) => e === day)) {
            reduce++;
        }
        day++;
    }
    return reduce;
}
function getWeekViewEventSpan({ event, offset, startOfWeek, excluded, }) {
    const begin = event.start < startOfWeek ? startOfWeek : event.start;
    let span = 1;
    if (event.end) {
        span = dateFns.differenceInDays(dateFns.addMinutes(dateFns.endOfDay(event.end), 1), dateFns.startOfDay(begin));
    }
    const totalLength = offset + span;
    if (totalLength > DAYS_IN_WEEK) {
        span = DAYS_IN_WEEK - offset;
    }
    return span - getExcludedDays({ startDate: begin, days: span, excluded });
}
export function getWeekViewEventOffset({ event, startOfWeek, excluded = [], }) {
    if (event.start < startOfWeek) {
        return 0;
    }
    const distance = dateFns.differenceInDays(event.start, startOfWeek);
    return distance - getExcludedDays({ startDate: startOfWeek, days: distance, excluded });
}
function isEventIsPeriod({ event, periodStart, periodEnd }) {
    const eventStart = event.start;
    const eventEnd = event.end || event.start;
    if (eventStart > periodStart && eventStart < periodEnd) {
        return true;
    }
    if (eventEnd > periodStart && eventEnd < periodEnd) {
        return true;
    }
    if (eventStart < periodStart && eventEnd > periodEnd) {
        return true;
    }
    if (dateFns.isSameSecond(eventStart, periodStart) || dateFns.isSameSecond(eventStart, periodEnd)) {
        return true;
    }
    if (dateFns.isSameSecond(eventEnd, periodStart) || dateFns.isSameSecond(eventEnd, periodEnd)) {
        return true;
    }
    return false;
}
function getEventsInPeriod({ events, periodStart, periodEnd }) {
    return events.filter((event) => isEventIsPeriod({ event, periodStart, periodEnd }));
}
function getEventsInTimeRange(events, dayStart, dayEnd) {
    return events.filter((event) => {
        const eventStart = event.start;
        const eventEnd = event.end || eventStart;
        const startOfView = dateFns.setMinutes(dateFns.setHours(dateFns.startOfDay(eventStart), dayStart.hour), dayStart.minute);
        const endOfView = dateFns.setMinutes(dateFns.setHours(dateFns.startOfMinute(eventStart), dayEnd.hour), dayEnd.minute);
        return dateFns.isAfter(eventEnd, startOfView) && dateFns.isBefore(eventStart, endOfView);
    });
}
function getWeekDay({ date }) {
    const today = dateFns.startOfDay(new Date());
    return {
        date,
        isPast: date < today,
        isToday: dateFns.isSameDay(date, today),
        isFuture: date > today,
        isWeekend: WEEKEND_DAY_NUMBERS.indexOf(dateFns.getDay(date)) > -1,
    };
}
export function getWeekViewHeader({ viewDate, weekStartsOn, excluded = [], }) {
    const start = dateFns.startOfWeek(viewDate, { weekStartsOn });
    const days = [];
    for (let i = 0; i < DAYS_IN_WEEK; i++) {
        const date = dateFns.addDays(start, i);
        if (!excluded.some((e) => date.getDay() === e)) {
            days.push(getWeekDay({ date }));
        }
    }
    return days;
}
export function getWeekView({ events = [], viewDate, weekStartsOn, excluded = [], hourSegments, segmentHeight, dayStart, dayEnd, }) {
    if (!events) {
        events = [];
    }
    const startOfViewWeek = dateFns.startOfWeek(viewDate, { weekStartsOn });
    const endOfViewWeek = dateFns.endOfWeek(viewDate, { weekStartsOn });
    const maxRange = DAYS_IN_WEEK - excluded.length;
    const eventsMapped = getEventsInTimeRange(getEventsInPeriod({ events, periodStart: startOfViewWeek, periodEnd: endOfViewWeek }), dayStart, dayEnd)
        .map((event) => {
        const offset = getWeekViewEventOffset({ event, startOfWeek: startOfViewWeek, excluded });
        const span = 1; // getWeekViewEventSpan({ event, offset, startOfWeek: startOfViewWeek, excluded });
        return { event, offset, span };
    })
        .filter((e) => e.offset < maxRange)
        .filter((e) => e.span > 0)
        .map((entry) => ({
        event: entry.event,
        offset: entry.offset,
        span: entry.span,
        startsBeforeWeek: entry.event.start < startOfViewWeek,
        endsAfterWeek: (entry.event.end || entry.event.start) > endOfViewWeek,
        top: 0,
    }))
        .sort((itemA, itemB) => {
        const startSecondsDiff = dateFns.differenceInSeconds(itemA.event.start, itemB.event.start);
        if (startSecondsDiff === 0) {
            return dateFns.differenceInSeconds(itemB.event.end || itemB.event.start, itemA.event.end || itemA.event.start);
        }
        return startSecondsDiff;
    })
        .map((entry) => {
        const startOfView = dateFns.setMinutes(dateFns.setHours(dateFns.startOfDay(entry.event.start), dayStart.hour), dayStart.minute);
        const endOfView = dateFns.setMinutes(dateFns.setHours(dateFns.startOfMinute(dateFns.endOfDay(entry.event.start)), dayEnd.hour), dayEnd.minute);
        const eventStart = entry.event.start;
        const eventEnd = entry.event.end || eventStart;
        const hourHeightModifier = (hourSegments * segmentHeight) / MINUTES_IN_HOUR;
        if (eventStart > startOfView) {
            entry.top += dateFns.differenceInMinutes(eventStart, startOfView);
        }
        entry.top *= hourHeightModifier;
        const startsBeforeDay = eventStart < startOfView;
        const endsAfterDay = eventEnd > endOfView;
        const startDate = startsBeforeDay ? startOfView : eventStart;
        const endDate = endsAfterDay ? endOfView : eventEnd;
        let height = dateFns.differenceInMinutes(endDate, startDate);
        if (!entry.event.end) {
            height = segmentHeight;
        }
        else {
            height *= hourHeightModifier;
        }
        entry.height = height;
        return entry;
    });
    const eventRows = [];
    const allocatedEvents = [];
    eventsMapped.forEach((event, index) => {
        if (allocatedEvents.indexOf(event) === -1) {
            allocatedEvents.push(event);
            const otherRowEvents = eventsMapped.slice(index + 1).filter((nextEvent) => {
                return nextEvent.top === event.top && nextEvent.offset === event.offset;
            });
            if (otherRowEvents.length > 0) {
                const totalEventsForRow = otherRowEvents.length + 1;
                event.span = 1 / totalEventsForRow;
                let nextOffset = event.span + event.offset;
                otherRowEvents.forEach((nextEvent) => {
                    nextEvent.offset = nextOffset;
                    nextEvent.span = event.span;
                    nextOffset = nextEvent.span + nextEvent.offset;
                });
                allocatedEvents.push(...otherRowEvents);
            }
            eventRows.push({
                row: [event, ...otherRowEvents],
            });
        }
    });
    return eventRows;
}
export function getMonthView({ events = [], viewDate, weekStartsOn, excluded = [], }) {
    if (!events) {
        events = [];
    }
    const start = dateFns.startOfWeek(dateFns.startOfMonth(viewDate), { weekStartsOn });
    const end = dateFns.endOfWeek(dateFns.endOfMonth(viewDate), { weekStartsOn });
    const eventsInMonth = getEventsInPeriod({
        events,
        periodStart: start,
        periodEnd: end,
    });
    const days = [];
    for (let i = 0; i < dateFns.differenceInDays(end, start) + 1; i++) {
        const date = dateFns.addDays(start, i);
        if (!excluded.some((e) => date.getDay() === e)) {
            const day = getWeekDay({ date });
            const calEvents = getEventsInPeriod({
                events: eventsInMonth,
                periodStart: dateFns.startOfDay(date),
                periodEnd: dateFns.endOfDay(date),
            });
            day.inMonth = dateFns.isSameMonth(date, viewDate);
            day.events = calEvents;
            day.badgeTotal = calEvents.length;
            days.push(day);
        }
    }
    const totalDaysVisibleInWeek = DAYS_IN_WEEK - excluded.length;
    const rows = Math.floor(days.length / totalDaysVisibleInWeek);
    const rowOffsets = [];
    for (let i = 0; i < rows; i++) {
        rowOffsets.push(i * totalDaysVisibleInWeek);
    }
    return {
        rowOffsets,
        totalDaysVisibleInWeek,
        days,
    };
}
export function getDayView({ events = [], viewDate, hourSegments, dayStart, dayEnd, eventWidth, segmentHeight }) {
    if (!events) {
        events = [];
    }
    const startOfView = dateFns.setMinutes(dateFns.setHours(dateFns.startOfDay(viewDate), dayStart.hour), dayStart.minute);
    const endOfView = dateFns.setMinutes(dateFns.setHours(dateFns.startOfMinute(dateFns.endOfDay(viewDate)), dayEnd.hour), dayEnd.minute);
    const previousDayEvents = [];
    const dayViewEvents = getEventsInTimeRange(getEventsInPeriod({
        events: events.filter((event) => !event.allDay),
        periodStart: startOfView,
        periodEnd: endOfView,
    }), dayStart, dayEnd)
        .sort((eventA, eventB) => {
        return eventA.start.valueOf() - eventB.start.valueOf();
    })
        .map((event) => {
        const eventStart = event.start;
        const eventEnd = event.end || eventStart;
        const startsBeforeDay = eventStart < startOfView;
        const endsAfterDay = eventEnd > endOfView;
        const hourHeightModifier = (hourSegments * segmentHeight) / MINUTES_IN_HOUR;
        let top = 0;
        if (eventStart > startOfView) {
            top += dateFns.differenceInMinutes(eventStart, startOfView);
        }
        top *= hourHeightModifier;
        const startDate = startsBeforeDay ? startOfView : eventStart;
        const endDate = endsAfterDay ? endOfView : eventEnd;
        let height = dateFns.differenceInMinutes(endDate, startDate);
        if (!event.end) {
            height = segmentHeight;
        }
        else {
            height *= hourHeightModifier;
        }
        const bottom = top + height;
        const overlappingPreviousEvents = previousDayEvents.filter((previousEvent) => {
            const previousEventTop = previousEvent.top;
            const previousEventBottom = previousEvent.top + previousEvent.height;
            if (top < previousEventBottom && previousEventBottom < bottom) {
                return true;
            }
            else if (previousEventTop <= top && bottom <= previousEventBottom) {
                return true;
            }
            return false;
        });
        let left = 0;
        while (overlappingPreviousEvents.some((previousEvent) => previousEvent.left === left)) {
            left += eventWidth;
        }
        const dayEvent = {
            event,
            height,
            width: eventWidth,
            top,
            left,
            startsBeforeDay,
            endsAfterDay,
        };
        if (height > 0) {
            previousDayEvents.push(dayEvent);
        }
        return dayEvent;
    })
        .filter((dayEvent) => dayEvent.height > 0);
    const width = Math.max(...dayViewEvents.map((event) => event.left + event.width));
    const allDayEvents = getEventsInPeriod({
        events: events.filter((event) => event.allDay),
        periodStart: dateFns.startOfDay(startOfView),
        periodEnd: dateFns.endOfDay(endOfView),
    });
    return {
        events: dayViewEvents,
        width,
        allDayEvents,
    };
}
export function getDayViewHourGrid({ viewDate, hourSegments, dayStart, dayEnd, }) {
    const hours = [];
    const startOfView = dateFns.setMinutes(dateFns.setHours(dateFns.startOfDay(viewDate), dayStart.hour), dayStart.minute);
    const endOfView = dateFns.setMinutes(dateFns.setHours(dateFns.startOfMinute(dateFns.endOfDay(viewDate)), dayEnd.hour), dayEnd.minute);
    const segmentDuration = MINUTES_IN_HOUR / hourSegments;
    const startOfViewDay = dateFns.startOfDay(viewDate);
    for (let i = 0; i < HOURS_IN_DAY; i++) {
        const segments = [];
        for (let j = 0; j < hourSegments; j++) {
            const date = dateFns.addMinutes(dateFns.addHours(startOfViewDay, i), j * segmentDuration);
            if (date >= startOfView && date < endOfView) {
                segments.push({
                    date,
                    isStart: j === 0,
                });
            }
        }
        if (segments.length > 0) {
            hours.push({ segments });
        }
    }
    return hours;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2FsZW5kYXJVdGlscy5qcyIsInNvdXJjZVJvb3QiOiJDOi9kZXYvZGV2bWFjaGluZS9ub3ZvLWVsZW1lbnRzL3Byb2plY3RzL25vdm8tZWxlbWVudHMvc3JjLyIsInNvdXJjZXMiOlsidXRpbHMvY2FsZW5kYXItdXRpbHMvQ2FsZW5kYXJVdGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssT0FBTyxNQUFNLFVBQVUsQ0FBQztBQUVwQyxNQUFNLG1CQUFtQixHQUFhLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzdDLE1BQU0sWUFBWSxHQUFXLENBQUMsQ0FBQztBQUMvQixNQUFNLFlBQVksR0FBVyxFQUFFLENBQUM7QUFDaEMsTUFBTSxlQUFlLEdBQVcsRUFBRSxDQUFDO0FBRW5DLE1BQU0sQ0FBTixJQUFZLHFCQUlYO0FBSkQsV0FBWSxxQkFBcUI7SUFDL0IsbUVBQUssQ0FBQTtJQUNMLHlFQUFRLENBQUE7SUFDUix5RUFBUSxDQUFBO0FBQ1YsQ0FBQyxFQUpXLHFCQUFxQixLQUFyQixxQkFBcUIsUUFJaEM7QUFnSUQsU0FBUyxlQUFlLENBQUMsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBeUQ7SUFDM0csSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtRQUN2QixPQUFPLENBQUMsQ0FBQztLQUNWO0lBQ0QsSUFBSSxHQUFHLEdBQVcsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ3JDLElBQUksTUFBTSxHQUFXLENBQUMsQ0FBQztJQUN2QixLQUFLLElBQUksQ0FBQyxHQUFXLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ3JDLElBQUksR0FBRyxLQUFLLFlBQVksRUFBRTtZQUN4QixHQUFHLEdBQUcsQ0FBQyxDQUFDO1NBQ1Q7UUFDRCxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsRUFBRTtZQUNuQyxNQUFNLEVBQUUsQ0FBQztTQUNWO1FBQ0QsR0FBRyxFQUFFLENBQUM7S0FDUDtJQUNELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFFRCxTQUFTLG9CQUFvQixDQUFDLEVBQzVCLEtBQUssRUFDTCxNQUFNLEVBQ04sV0FBVyxFQUNYLFFBQVEsR0FNVDtJQUNDLE1BQU0sS0FBSyxHQUFTLEtBQUssQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7SUFDMUUsSUFBSSxJQUFJLEdBQVcsQ0FBQyxDQUFDO0lBQ3JCLElBQUksS0FBSyxDQUFDLEdBQUcsRUFBRTtRQUNiLElBQUksR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7S0FDaEg7SUFDRCxNQUFNLFdBQVcsR0FBVyxNQUFNLEdBQUcsSUFBSSxDQUFDO0lBQzFDLElBQUksV0FBVyxHQUFHLFlBQVksRUFBRTtRQUM5QixJQUFJLEdBQUcsWUFBWSxHQUFHLE1BQU0sQ0FBQztLQUM5QjtJQUNELE9BQU8sSUFBSSxHQUFHLGVBQWUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO0FBQzVFLENBQUM7QUFFRCxNQUFNLFVBQVUsc0JBQXNCLENBQUMsRUFDckMsS0FBSyxFQUNMLFdBQVcsRUFDWCxRQUFRLEdBQUcsRUFBRSxHQUtkO0lBQ0MsSUFBSSxLQUFLLENBQUMsS0FBSyxHQUFHLFdBQVcsRUFBRTtRQUM3QixPQUFPLENBQUMsQ0FBQztLQUNWO0lBQ0QsTUFBTSxRQUFRLEdBQVcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDNUUsT0FBTyxRQUFRLEdBQUcsZUFBZSxDQUFDLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7QUFDMUYsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQXVCO0lBQzdFLE1BQU0sVUFBVSxHQUFTLEtBQUssQ0FBQyxLQUFLLENBQUM7SUFDckMsTUFBTSxRQUFRLEdBQVMsS0FBSyxDQUFDLEdBQUcsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDO0lBRWhELElBQUksVUFBVSxHQUFHLFdBQVcsSUFBSSxVQUFVLEdBQUcsU0FBUyxFQUFFO1FBQ3RELE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFFRCxJQUFJLFFBQVEsR0FBRyxXQUFXLElBQUksUUFBUSxHQUFHLFNBQVMsRUFBRTtRQUNsRCxPQUFPLElBQUksQ0FBQztLQUNiO0lBRUQsSUFBSSxVQUFVLEdBQUcsV0FBVyxJQUFJLFFBQVEsR0FBRyxTQUFTLEVBQUU7UUFDcEQsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUVELElBQUksT0FBTyxDQUFDLFlBQVksQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLElBQUksT0FBTyxDQUFDLFlBQVksQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDLEVBQUU7UUFDaEcsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUVELElBQUksT0FBTyxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDLElBQUksT0FBTyxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDLEVBQUU7UUFDNUYsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUVELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQztBQUVELFNBQVMsaUJBQWlCLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBeUI7SUFDbEYsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBb0IsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDckcsQ0FBQztBQUVELFNBQVMsb0JBQW9CLENBQUMsTUFBdUIsRUFBRSxRQUFhLEVBQUUsTUFBVztJQUMvRSxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtRQUM3QixNQUFNLFVBQVUsR0FBUyxLQUFLLENBQUMsS0FBSyxDQUFDO1FBQ3JDLE1BQU0sUUFBUSxHQUFTLEtBQUssQ0FBQyxHQUFHLElBQUksVUFBVSxDQUFDO1FBRS9DLE1BQU0sV0FBVyxHQUFTLE9BQU8sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDL0gsTUFBTSxTQUFTLEdBQVMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUU1SCxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzNGLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLEVBQUUsSUFBSSxFQUFrQjtJQUMxQyxNQUFNLEtBQUssR0FBUyxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNuRCxPQUFPO1FBQ0wsSUFBSTtRQUNKLE1BQU0sRUFBRSxJQUFJLEdBQUcsS0FBSztRQUNwQixPQUFPLEVBQUUsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDO1FBQ3ZDLFFBQVEsRUFBRSxJQUFJLEdBQUcsS0FBSztRQUN0QixTQUFTLEVBQUUsbUJBQW1CLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDbEUsQ0FBQztBQUNKLENBQUM7QUFFRCxNQUFNLFVBQVUsaUJBQWlCLENBQUMsRUFDaEMsUUFBUSxFQUNSLFlBQVksRUFDWixRQUFRLEdBQUcsRUFBRSxHQUtkO0lBQ0MsTUFBTSxLQUFLLEdBQVMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO0lBQ3BFLE1BQU0sSUFBSSxHQUFjLEVBQUUsQ0FBQztJQUMzQixLQUFLLElBQUksQ0FBQyxHQUFXLENBQUMsRUFBRSxDQUFDLEdBQUcsWUFBWSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQzdDLE1BQU0sSUFBSSxHQUFTLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDOUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDakM7S0FDRjtJQUVELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVELE1BQU0sVUFBVSxXQUFXLENBQUMsRUFDMUIsTUFBTSxHQUFHLEVBQUUsRUFDWCxRQUFRLEVBQ1IsWUFBWSxFQUNaLFFBQVEsR0FBRyxFQUFFLEVBQ2IsWUFBWSxFQUNaLGFBQWEsRUFDYixRQUFRLEVBQ1IsTUFBTSxHQVVQO0lBQ0MsSUFBSSxDQUFDLE1BQU0sRUFBRTtRQUNYLE1BQU0sR0FBRyxFQUFFLENBQUM7S0FDYjtJQUVELE1BQU0sZUFBZSxHQUFTLE9BQU8sQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztJQUM5RSxNQUFNLGFBQWEsR0FBUyxPQUFPLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUM7SUFDMUUsTUFBTSxRQUFRLEdBQVcsWUFBWSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUM7SUFFeEQsTUFBTSxZQUFZLEdBQW9CLG9CQUFvQixDQUN4RCxpQkFBaUIsQ0FBQyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsZUFBZSxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsQ0FBQyxFQUNyRixRQUFRLEVBQ1IsTUFBTSxDQUNQO1NBQ0UsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7UUFDYixNQUFNLE1BQU0sR0FBVyxzQkFBc0IsQ0FBQyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsZUFBZSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDakcsTUFBTSxJQUFJLEdBQVcsQ0FBQyxDQUFDLENBQUMsbUZBQW1GO1FBQzNHLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDO0lBQ2pDLENBQUMsQ0FBQztTQUNELE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUM7U0FDbEMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztTQUN6QixHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDZixLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7UUFDbEIsTUFBTSxFQUFFLEtBQUssQ0FBQyxNQUFNO1FBQ3BCLElBQUksRUFBRSxLQUFLLENBQUMsSUFBSTtRQUNoQixnQkFBZ0IsRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxlQUFlO1FBQ3JELGFBQWEsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsYUFBYTtRQUNyRSxHQUFHLEVBQUUsQ0FBQztLQUNQLENBQUMsQ0FBQztTQUNGLElBQUksQ0FDSCxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQVUsRUFBRTtRQUN2QixNQUFNLGdCQUFnQixHQUFXLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25HLElBQUksZ0JBQWdCLEtBQUssQ0FBQyxFQUFFO1lBQzFCLE9BQU8sT0FBTyxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDaEg7UUFDRCxPQUFPLGdCQUFnQixDQUFDO0lBQzFCLENBQUMsQ0FDRjtTQUNBLEdBQUcsQ0FBQyxDQUFDLEtBQW9CLEVBQUUsRUFBRTtRQUM1QixNQUFNLFdBQVcsR0FBUyxPQUFPLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdEksTUFBTSxTQUFTLEdBQVMsT0FBTyxDQUFDLFVBQVUsQ0FDeEMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFDekYsTUFBTSxDQUFDLE1BQU0sQ0FDZCxDQUFDO1FBRUYsTUFBTSxVQUFVLEdBQVMsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7UUFDM0MsTUFBTSxRQUFRLEdBQVMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksVUFBVSxDQUFDO1FBRXJELE1BQU0sa0JBQWtCLEdBQVcsQ0FBQyxZQUFZLEdBQUcsYUFBYSxDQUFDLEdBQUcsZUFBZSxDQUFDO1FBRXBGLElBQUksVUFBVSxHQUFHLFdBQVcsRUFBRTtZQUM1QixLQUFLLENBQUMsR0FBRyxJQUFJLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxVQUFVLEVBQUUsV0FBVyxDQUFDLENBQUM7U0FDbkU7UUFFRCxLQUFLLENBQUMsR0FBRyxJQUFJLGtCQUFrQixDQUFDO1FBRWhDLE1BQU0sZUFBZSxHQUFZLFVBQVUsR0FBRyxXQUFXLENBQUM7UUFDMUQsTUFBTSxZQUFZLEdBQVksUUFBUSxHQUFHLFNBQVMsQ0FBQztRQUVuRCxNQUFNLFNBQVMsR0FBUyxlQUFlLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDO1FBQ25FLE1BQU0sT0FBTyxHQUFTLFlBQVksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7UUFFMUQsSUFBSSxNQUFNLEdBQVcsT0FBTyxDQUFDLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztRQUVyRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUU7WUFDcEIsTUFBTSxHQUFHLGFBQWEsQ0FBQztTQUN4QjthQUFNO1lBQ0wsTUFBTSxJQUFJLGtCQUFrQixDQUFDO1NBQzlCO1FBRUQsS0FBSyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFFdEIsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDLENBQUMsQ0FBQztJQUVMLE1BQU0sU0FBUyxHQUF1QixFQUFFLENBQUM7SUFDekMsTUFBTSxlQUFlLEdBQW9CLEVBQUUsQ0FBQztJQUU1QyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBb0IsRUFBRSxLQUFhLEVBQUUsRUFBRTtRQUMzRCxJQUFJLGVBQWUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDekMsZUFBZSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUU1QixNQUFNLGNBQWMsR0FBb0IsWUFBWSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUU7Z0JBQ3pGLE9BQU8sU0FBUyxDQUFDLEdBQUcsS0FBSyxLQUFLLENBQUMsR0FBRyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEtBQUssS0FBSyxDQUFDLE1BQU0sQ0FBQztZQUMxRSxDQUFDLENBQUMsQ0FBQztZQUVILElBQUksY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQzdCLE1BQU0saUJBQWlCLEdBQUcsY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7Z0JBRXBELEtBQUssQ0FBQyxJQUFJLEdBQUcsQ0FBQyxHQUFHLGlCQUFpQixDQUFDO2dCQUVuQyxJQUFJLFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7Z0JBRTNDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUF3QixFQUFFLEVBQUU7b0JBQ2xELFNBQVMsQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDO29CQUM5QixTQUFTLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7b0JBQzVCLFVBQVUsR0FBRyxTQUFTLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUM7Z0JBQ2pELENBQUMsQ0FBQyxDQUFDO2dCQUVILGVBQWUsQ0FBQyxJQUFJLENBQUMsR0FBRyxjQUFjLENBQUMsQ0FBQzthQUN6QztZQUVELFNBQVMsQ0FBQyxJQUFJLENBQUM7Z0JBQ2IsR0FBRyxFQUFFLENBQUMsS0FBSyxFQUFFLEdBQUcsY0FBYyxDQUFDO2FBQ2hDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDO0FBRUQsTUFBTSxVQUFVLFlBQVksQ0FBQyxFQUMzQixNQUFNLEdBQUcsRUFBRSxFQUNYLFFBQVEsRUFDUixZQUFZLEVBQ1osUUFBUSxHQUFHLEVBQUUsR0FNZDtJQUNDLElBQUksQ0FBQyxNQUFNLEVBQUU7UUFDWCxNQUFNLEdBQUcsRUFBRSxDQUFDO0tBQ2I7SUFFRCxNQUFNLEtBQUssR0FBUyxPQUFPLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO0lBQzFGLE1BQU0sR0FBRyxHQUFTLE9BQU8sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUM7SUFDcEYsTUFBTSxhQUFhLEdBQW9CLGlCQUFpQixDQUFDO1FBQ3ZELE1BQU07UUFDTixXQUFXLEVBQUUsS0FBSztRQUNsQixTQUFTLEVBQUUsR0FBRztLQUNmLENBQUMsQ0FBQztJQUNILE1BQU0sSUFBSSxHQUFtQixFQUFFLENBQUM7SUFDaEMsS0FBSyxJQUFJLENBQUMsR0FBVyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ3pFLE1BQU0sSUFBSSxHQUFTLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDOUMsTUFBTSxHQUFHLEdBQWlCLFVBQVUsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFpQixDQUFDO1lBQy9ELE1BQU0sU0FBUyxHQUFvQixpQkFBaUIsQ0FBQztnQkFDbkQsTUFBTSxFQUFFLGFBQWE7Z0JBQ3JCLFdBQVcsRUFBRSxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztnQkFDckMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO2FBQ2xDLENBQUMsQ0FBQztZQUNILEdBQUcsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDbEQsR0FBRyxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUM7WUFDdkIsR0FBRyxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDO1lBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDaEI7S0FDRjtJQUVELE1BQU0sc0JBQXNCLEdBQVcsWUFBWSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUM7SUFDdEUsTUFBTSxJQUFJLEdBQVcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLHNCQUFzQixDQUFDLENBQUM7SUFDdEUsTUFBTSxVQUFVLEdBQWEsRUFBRSxDQUFDO0lBQ2hDLEtBQUssSUFBSSxDQUFDLEdBQVcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDckMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsc0JBQXNCLENBQUMsQ0FBQztLQUM3QztJQUVELE9BQU87UUFDTCxVQUFVO1FBQ1Ysc0JBQXNCO1FBQ3RCLElBQUk7S0FDTCxDQUFDO0FBQ0osQ0FBQztBQUVELE1BQU0sVUFBVSxVQUFVLENBQUMsRUFBRSxNQUFNLEdBQUcsRUFBRSxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFrQjtJQUM3SCxJQUFJLENBQUMsTUFBTSxFQUFFO1FBQ1gsTUFBTSxHQUFHLEVBQUUsQ0FBQztLQUNiO0lBRUQsTUFBTSxXQUFXLEdBQVMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM3SCxNQUFNLFNBQVMsR0FBUyxPQUFPLENBQUMsVUFBVSxDQUN4QyxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFDaEYsTUFBTSxDQUFDLE1BQU0sQ0FDZCxDQUFDO0lBQ0YsTUFBTSxpQkFBaUIsR0FBbUIsRUFBRSxDQUFDO0lBRTdDLE1BQU0sYUFBYSxHQUFtQixvQkFBb0IsQ0FDeEQsaUJBQWlCLENBQUM7UUFDaEIsTUFBTSxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFvQixFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDOUQsV0FBVyxFQUFFLFdBQVc7UUFDeEIsU0FBUyxFQUFFLFNBQVM7S0FDckIsQ0FBQyxFQUNGLFFBQVEsRUFDUixNQUFNLENBQ1A7U0FDRSxJQUFJLENBQUMsQ0FBQyxNQUFxQixFQUFFLE1BQXFCLEVBQUUsRUFBRTtRQUNyRCxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUN6RCxDQUFDLENBQUM7U0FDRCxHQUFHLENBQUMsQ0FBQyxLQUFvQixFQUFFLEVBQUU7UUFDNUIsTUFBTSxVQUFVLEdBQVMsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUNyQyxNQUFNLFFBQVEsR0FBUyxLQUFLLENBQUMsR0FBRyxJQUFJLFVBQVUsQ0FBQztRQUMvQyxNQUFNLGVBQWUsR0FBWSxVQUFVLEdBQUcsV0FBVyxDQUFDO1FBQzFELE1BQU0sWUFBWSxHQUFZLFFBQVEsR0FBRyxTQUFTLENBQUM7UUFDbkQsTUFBTSxrQkFBa0IsR0FBVyxDQUFDLFlBQVksR0FBRyxhQUFhLENBQUMsR0FBRyxlQUFlLENBQUM7UUFFcEYsSUFBSSxHQUFHLEdBQVcsQ0FBQyxDQUFDO1FBRXBCLElBQUksVUFBVSxHQUFHLFdBQVcsRUFBRTtZQUM1QixHQUFHLElBQUksT0FBTyxDQUFDLG1CQUFtQixDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQztTQUM3RDtRQUVELEdBQUcsSUFBSSxrQkFBa0IsQ0FBQztRQUUxQixNQUFNLFNBQVMsR0FBUyxlQUFlLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDO1FBQ25FLE1BQU0sT0FBTyxHQUFTLFlBQVksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7UUFFMUQsSUFBSSxNQUFNLEdBQVcsT0FBTyxDQUFDLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztRQUVyRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRTtZQUNkLE1BQU0sR0FBRyxhQUFhLENBQUM7U0FDeEI7YUFBTTtZQUNMLE1BQU0sSUFBSSxrQkFBa0IsQ0FBQztTQUM5QjtRQUVELE1BQU0sTUFBTSxHQUFXLEdBQUcsR0FBRyxNQUFNLENBQUM7UUFFcEMsTUFBTSx5QkFBeUIsR0FBbUIsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUMsYUFBMkIsRUFBRSxFQUFFO1lBQ3pHLE1BQU0sZ0JBQWdCLEdBQVcsYUFBYSxDQUFDLEdBQUcsQ0FBQztZQUNuRCxNQUFNLG1CQUFtQixHQUFXLGFBQWEsQ0FBQyxHQUFHLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQztZQUU3RSxJQUFJLEdBQUcsR0FBRyxtQkFBbUIsSUFBSSxtQkFBbUIsR0FBRyxNQUFNLEVBQUU7Z0JBQzdELE9BQU8sSUFBSSxDQUFDO2FBQ2I7aUJBQU0sSUFBSSxnQkFBZ0IsSUFBSSxHQUFHLElBQUksTUFBTSxJQUFJLG1CQUFtQixFQUFFO2dCQUNuRSxPQUFPLElBQUksQ0FBQzthQUNiO1lBRUQsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksSUFBSSxHQUFXLENBQUMsQ0FBQztRQUVyQixPQUFPLHlCQUF5QixDQUFDLElBQUksQ0FBQyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsYUFBYSxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsRUFBRTtZQUNyRixJQUFJLElBQUksVUFBVSxDQUFDO1NBQ3BCO1FBRUQsTUFBTSxRQUFRLEdBQWlCO1lBQzdCLEtBQUs7WUFDTCxNQUFNO1lBQ04sS0FBSyxFQUFFLFVBQVU7WUFDakIsR0FBRztZQUNILElBQUk7WUFDSixlQUFlO1lBQ2YsWUFBWTtTQUNiLENBQUM7UUFFRixJQUFJLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDZCxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDbEM7UUFFRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDLENBQUM7U0FDRCxNQUFNLENBQUMsQ0FBQyxRQUFzQixFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBRTNELE1BQU0sS0FBSyxHQUFXLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBbUIsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUN4RyxNQUFNLFlBQVksR0FBb0IsaUJBQWlCLENBQUM7UUFDdEQsTUFBTSxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFvQixFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQzdELFdBQVcsRUFBRSxPQUFPLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUM1QyxTQUFTLEVBQUUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUM7S0FDdkMsQ0FBQyxDQUFDO0lBRUgsT0FBTztRQUNMLE1BQU0sRUFBRSxhQUFhO1FBQ3JCLEtBQUs7UUFDTCxZQUFZO0tBQ2IsQ0FBQztBQUNKLENBQUM7QUFFRCxNQUFNLFVBQVUsa0JBQWtCLENBQUMsRUFDakMsUUFBUSxFQUNSLFlBQVksRUFDWixRQUFRLEVBQ1IsTUFBTSxHQU1QO0lBQ0MsTUFBTSxLQUFLLEdBQWtCLEVBQUUsQ0FBQztJQUVoQyxNQUFNLFdBQVcsR0FBUyxPQUFPLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzdILE1BQU0sU0FBUyxHQUFTLE9BQU8sQ0FBQyxVQUFVLENBQ3hDLE9BQU8sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUNoRixNQUFNLENBQUMsTUFBTSxDQUNkLENBQUM7SUFDRixNQUFNLGVBQWUsR0FBVyxlQUFlLEdBQUcsWUFBWSxDQUFDO0lBQy9ELE1BQU0sY0FBYyxHQUFTLE9BQU8sQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFMUQsS0FBSyxJQUFJLENBQUMsR0FBVyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFlBQVksRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUM3QyxNQUFNLFFBQVEsR0FBeUIsRUFBRSxDQUFDO1FBQzFDLEtBQUssSUFBSSxDQUFDLEdBQVcsQ0FBQyxFQUFFLENBQUMsR0FBRyxZQUFZLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDN0MsTUFBTSxJQUFJLEdBQVMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsZUFBZSxDQUFDLENBQUM7WUFDaEcsSUFBSSxJQUFJLElBQUksV0FBVyxJQUFJLElBQUksR0FBRyxTQUFTLEVBQUU7Z0JBQzNDLFFBQVEsQ0FBQyxJQUFJLENBQUM7b0JBQ1osSUFBSTtvQkFDSixPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUM7aUJBQ2pCLENBQUMsQ0FBQzthQUNKO1NBQ0Y7UUFDRCxJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3ZCLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO1NBQzFCO0tBQ0Y7SUFFRCxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBkYXRlRm5zIGZyb20gJ2RhdGUtZm5zJztcclxuXHJcbmNvbnN0IFdFRUtFTkRfREFZX05VTUJFUlM6IG51bWJlcltdID0gWzAsIDZdO1xyXG5jb25zdCBEQVlTX0lOX1dFRUs6IG51bWJlciA9IDc7XHJcbmNvbnN0IEhPVVJTX0lOX0RBWTogbnVtYmVyID0gMjQ7XHJcbmNvbnN0IE1JTlVURVNfSU5fSE9VUjogbnVtYmVyID0gNjA7XHJcblxyXG5leHBvcnQgZW51bSBDYWxlbmRhckV2ZW50UmVzcG9uc2Uge1xyXG4gIE1heWJlLFxyXG4gIEFjY2VwdGVkLFxyXG4gIFJlamVjdGVkLFxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIENhbGVuZGFyRXZlbnRUaW1lc0NoYW5nZWRFdmVudCB7XHJcbiAgZXZlbnQ6IENhbGVuZGFyRXZlbnQ7XHJcbiAgbmV3U3RhcnQ6IERhdGU7XHJcbiAgbmV3RW5kPzogRGF0ZTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBXZWVrRGF5IHtcclxuICBkYXRlOiBEYXRlO1xyXG4gIGlzUGFzdDogYm9vbGVhbjtcclxuICBpc1RvZGF5OiBib29sZWFuO1xyXG4gIGlzRnV0dXJlOiBib29sZWFuO1xyXG4gIGlzV2Vla2VuZDogYm9vbGVhbjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBFdmVudENvbG9yIHtcclxuICBwcmltYXJ5OiBzdHJpbmc7XHJcbiAgc2Vjb25kYXJ5OiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRBY3Rpb24ge1xyXG4gIGxhYmVsOiBzdHJpbmc7XHJcbiAgY3NzQ2xhc3M/OiBzdHJpbmc7XHJcbiAgb25DbGljayh7IGV2ZW50IH06IHsgZXZlbnQ6IENhbGVuZGFyRXZlbnQgfSk6IGFueTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDYWxlbmRhckV2ZW50IHtcclxuICBpZD86IG51bWJlcjtcclxuICBzdGFydDogRGF0ZTtcclxuICBlbmQ/OiBEYXRlO1xyXG4gIHRpdGxlOiBzdHJpbmc7XHJcbiAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XHJcbiAgY29sb3I6IEV2ZW50Q29sb3I7XHJcbiAgdHlwZT86IHN0cmluZztcclxuICByZXNwb25zZT86IENhbGVuZGFyRXZlbnRSZXNwb25zZTtcclxuICBhY3Rpb25zPzogRXZlbnRBY3Rpb25bXTtcclxuICBhbGxEYXk/OiBib29sZWFuO1xyXG4gIGNzc0NsYXNzPzogc3RyaW5nO1xyXG4gIHJlc2l6YWJsZT86IHtcclxuICAgIGJlZm9yZVN0YXJ0PzogYm9vbGVhbjtcclxuICAgIGFmdGVyRW5kPzogYm9vbGVhbjtcclxuICB9O1xyXG4gIGRyYWdnYWJsZT86IGJvb2xlYW47XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgV2Vla1ZpZXdFdmVudCB7XHJcbiAgZXZlbnQ6IENhbGVuZGFyRXZlbnQ7XHJcbiAgb2Zmc2V0OiBudW1iZXI7XHJcbiAgc3BhbjogbnVtYmVyO1xyXG4gIHN0YXJ0c0JlZm9yZVdlZWs6IGJvb2xlYW47XHJcbiAgZW5kc0FmdGVyV2VlazogYm9vbGVhbjtcclxuICB0b3A/OiBudW1iZXI7XHJcbiAgaGVpZ2h0PzogbnVtYmVyO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFdlZWtWaWV3RXZlbnRSb3cge1xyXG4gIHJvdzogV2Vla1ZpZXdFdmVudFtdO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIE1vbnRoVmlld0RheSBleHRlbmRzIFdlZWtEYXkge1xyXG4gIGluTW9udGg6IGJvb2xlYW47XHJcbiAgZXZlbnRzOiBDYWxlbmRhckV2ZW50W107XHJcbiAgYmFja2dyb3VuZENvbG9yPzogc3RyaW5nO1xyXG4gIGNzc0NsYXNzPzogc3RyaW5nO1xyXG4gIGJhZGdlVG90YWw6IG51bWJlcjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBNb250aFZpZXcge1xyXG4gIHJvd09mZnNldHM6IG51bWJlcltdO1xyXG4gIGRheXM6IE1vbnRoVmlld0RheVtdO1xyXG4gIHRvdGFsRGF5c1Zpc2libGVJbldlZWs6IG51bWJlcjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBEYXlWaWV3RXZlbnQge1xyXG4gIGV2ZW50OiBDYWxlbmRhckV2ZW50O1xyXG4gIGhlaWdodDogbnVtYmVyO1xyXG4gIHdpZHRoOiBudW1iZXI7XHJcbiAgdG9wOiBudW1iZXI7XHJcbiAgbGVmdDogbnVtYmVyO1xyXG4gIHN0YXJ0c0JlZm9yZURheTogYm9vbGVhbjtcclxuICBlbmRzQWZ0ZXJEYXk6IGJvb2xlYW47XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRGF5VmlldyB7XHJcbiAgZXZlbnRzOiBEYXlWaWV3RXZlbnRbXTtcclxuICB3aWR0aDogbnVtYmVyO1xyXG4gIGFsbERheUV2ZW50czogQ2FsZW5kYXJFdmVudFtdO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERheVZpZXdIb3VyU2VnbWVudCB7XHJcbiAgaXNTdGFydDogYm9vbGVhbjtcclxuICBkYXRlOiBEYXRlO1xyXG4gIGNzc0NsYXNzPzogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERheVZpZXdIb3VyIHtcclxuICBzZWdtZW50czogRGF5Vmlld0hvdXJTZWdtZW50W107XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSXNFdmVudEluUGVyaW9kQXJncyB7XHJcbiAgZXZlbnQ6IENhbGVuZGFyRXZlbnQ7XHJcbiAgcGVyaW9kU3RhcnQ6IERhdGU7XHJcbiAgcGVyaW9kRW5kOiBEYXRlO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEdldEV2ZW50c0luUGVyaW9kQXJncyB7XHJcbiAgZXZlbnRzOiBDYWxlbmRhckV2ZW50W107XHJcbiAgcGVyaW9kU3RhcnQ6IERhdGU7XHJcbiAgcGVyaW9kRW5kOiBEYXRlO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEdldERheVZpZXdBcmdzIHtcclxuICBldmVudHM/OiBDYWxlbmRhckV2ZW50W107XHJcbiAgdmlld0RhdGU6IERhdGU7XHJcbiAgaG91clNlZ21lbnRzOiBudW1iZXI7XHJcbiAgZGF5U3RhcnQ6IHtcclxuICAgIGhvdXI6IG51bWJlcjtcclxuICAgIG1pbnV0ZTogbnVtYmVyO1xyXG4gIH07XHJcbiAgZGF5RW5kOiB7XHJcbiAgICBob3VyOiBudW1iZXI7XHJcbiAgICBtaW51dGU6IG51bWJlcjtcclxuICB9O1xyXG4gIGV2ZW50V2lkdGg6IG51bWJlcjtcclxuICBzZWdtZW50SGVpZ2h0OiBudW1iZXI7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEV4Y2x1ZGVkRGF5cyh7IHN0YXJ0RGF0ZSwgZGF5cywgZXhjbHVkZWQgfTogeyBzdGFydERhdGU6IERhdGU7IGRheXM6IG51bWJlcjsgZXhjbHVkZWQ6IG51bWJlcltdIH0pOiBudW1iZXIge1xyXG4gIGlmIChleGNsdWRlZC5sZW5ndGggPCAxKSB7XHJcbiAgICByZXR1cm4gMDtcclxuICB9XHJcbiAgbGV0IGRheTogbnVtYmVyID0gc3RhcnREYXRlLmdldERheSgpO1xyXG4gIGxldCByZWR1Y2U6IG51bWJlciA9IDA7XHJcbiAgZm9yIChsZXQgaTogbnVtYmVyID0gMDsgaSA8IGRheXM7IGkrKykge1xyXG4gICAgaWYgKGRheSA9PT0gREFZU19JTl9XRUVLKSB7XHJcbiAgICAgIGRheSA9IDA7XHJcbiAgICB9XHJcbiAgICBpZiAoZXhjbHVkZWQuc29tZSgoZSkgPT4gZSA9PT0gZGF5KSkge1xyXG4gICAgICByZWR1Y2UrKztcclxuICAgIH1cclxuICAgIGRheSsrO1xyXG4gIH1cclxuICByZXR1cm4gcmVkdWNlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRXZWVrVmlld0V2ZW50U3Bhbih7XHJcbiAgZXZlbnQsXHJcbiAgb2Zmc2V0LFxyXG4gIHN0YXJ0T2ZXZWVrLFxyXG4gIGV4Y2x1ZGVkLFxyXG59OiB7XHJcbiAgZXZlbnQ6IENhbGVuZGFyRXZlbnQ7XHJcbiAgb2Zmc2V0OiBudW1iZXI7XHJcbiAgc3RhcnRPZldlZWs6IERhdGU7XHJcbiAgZXhjbHVkZWQ6IG51bWJlcltdO1xyXG59KTogbnVtYmVyIHtcclxuICBjb25zdCBiZWdpbjogRGF0ZSA9IGV2ZW50LnN0YXJ0IDwgc3RhcnRPZldlZWsgPyBzdGFydE9mV2VlayA6IGV2ZW50LnN0YXJ0O1xyXG4gIGxldCBzcGFuOiBudW1iZXIgPSAxO1xyXG4gIGlmIChldmVudC5lbmQpIHtcclxuICAgIHNwYW4gPSBkYXRlRm5zLmRpZmZlcmVuY2VJbkRheXMoZGF0ZUZucy5hZGRNaW51dGVzKGRhdGVGbnMuZW5kT2ZEYXkoZXZlbnQuZW5kKSwgMSksIGRhdGVGbnMuc3RhcnRPZkRheShiZWdpbikpO1xyXG4gIH1cclxuICBjb25zdCB0b3RhbExlbmd0aDogbnVtYmVyID0gb2Zmc2V0ICsgc3BhbjtcclxuICBpZiAodG90YWxMZW5ndGggPiBEQVlTX0lOX1dFRUspIHtcclxuICAgIHNwYW4gPSBEQVlTX0lOX1dFRUsgLSBvZmZzZXQ7XHJcbiAgfVxyXG4gIHJldHVybiBzcGFuIC0gZ2V0RXhjbHVkZWREYXlzKHsgc3RhcnREYXRlOiBiZWdpbiwgZGF5czogc3BhbiwgZXhjbHVkZWQgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRXZWVrVmlld0V2ZW50T2Zmc2V0KHtcclxuICBldmVudCxcclxuICBzdGFydE9mV2VlayxcclxuICBleGNsdWRlZCA9IFtdLFxyXG59OiB7XHJcbiAgZXZlbnQ6IENhbGVuZGFyRXZlbnQ7XHJcbiAgc3RhcnRPZldlZWs6IERhdGU7XHJcbiAgZXhjbHVkZWQ/OiBudW1iZXJbXTtcclxufSk6IG51bWJlciB7XHJcbiAgaWYgKGV2ZW50LnN0YXJ0IDwgc3RhcnRPZldlZWspIHtcclxuICAgIHJldHVybiAwO1xyXG4gIH1cclxuICBjb25zdCBkaXN0YW5jZTogbnVtYmVyID0gZGF0ZUZucy5kaWZmZXJlbmNlSW5EYXlzKGV2ZW50LnN0YXJ0LCBzdGFydE9mV2Vlayk7XHJcbiAgcmV0dXJuIGRpc3RhbmNlIC0gZ2V0RXhjbHVkZWREYXlzKHsgc3RhcnREYXRlOiBzdGFydE9mV2VlaywgZGF5czogZGlzdGFuY2UsIGV4Y2x1ZGVkIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc0V2ZW50SXNQZXJpb2QoeyBldmVudCwgcGVyaW9kU3RhcnQsIHBlcmlvZEVuZCB9OiBJc0V2ZW50SW5QZXJpb2RBcmdzKTogYm9vbGVhbiB7XHJcbiAgY29uc3QgZXZlbnRTdGFydDogRGF0ZSA9IGV2ZW50LnN0YXJ0O1xyXG4gIGNvbnN0IGV2ZW50RW5kOiBEYXRlID0gZXZlbnQuZW5kIHx8IGV2ZW50LnN0YXJ0O1xyXG5cclxuICBpZiAoZXZlbnRTdGFydCA+IHBlcmlvZFN0YXJ0ICYmIGV2ZW50U3RhcnQgPCBwZXJpb2RFbmQpIHtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgaWYgKGV2ZW50RW5kID4gcGVyaW9kU3RhcnQgJiYgZXZlbnRFbmQgPCBwZXJpb2RFbmQpIHtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgaWYgKGV2ZW50U3RhcnQgPCBwZXJpb2RTdGFydCAmJiBldmVudEVuZCA+IHBlcmlvZEVuZCkge1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICBpZiAoZGF0ZUZucy5pc1NhbWVTZWNvbmQoZXZlbnRTdGFydCwgcGVyaW9kU3RhcnQpIHx8IGRhdGVGbnMuaXNTYW1lU2Vjb25kKGV2ZW50U3RhcnQsIHBlcmlvZEVuZCkpIHtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgaWYgKGRhdGVGbnMuaXNTYW1lU2Vjb25kKGV2ZW50RW5kLCBwZXJpb2RTdGFydCkgfHwgZGF0ZUZucy5pc1NhbWVTZWNvbmQoZXZlbnRFbmQsIHBlcmlvZEVuZCkpIHtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGZhbHNlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRFdmVudHNJblBlcmlvZCh7IGV2ZW50cywgcGVyaW9kU3RhcnQsIHBlcmlvZEVuZCB9OiBHZXRFdmVudHNJblBlcmlvZEFyZ3MpOiBDYWxlbmRhckV2ZW50W10ge1xyXG4gIHJldHVybiBldmVudHMuZmlsdGVyKChldmVudDogQ2FsZW5kYXJFdmVudCkgPT4gaXNFdmVudElzUGVyaW9kKHsgZXZlbnQsIHBlcmlvZFN0YXJ0LCBwZXJpb2RFbmQgfSkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRFdmVudHNJblRpbWVSYW5nZShldmVudHM6IENhbGVuZGFyRXZlbnRbXSwgZGF5U3RhcnQ6IGFueSwgZGF5RW5kOiBhbnkpIHtcclxuICByZXR1cm4gZXZlbnRzLmZpbHRlcigoZXZlbnQpID0+IHtcclxuICAgIGNvbnN0IGV2ZW50U3RhcnQ6IERhdGUgPSBldmVudC5zdGFydDtcclxuICAgIGNvbnN0IGV2ZW50RW5kOiBEYXRlID0gZXZlbnQuZW5kIHx8IGV2ZW50U3RhcnQ7XHJcblxyXG4gICAgY29uc3Qgc3RhcnRPZlZpZXc6IERhdGUgPSBkYXRlRm5zLnNldE1pbnV0ZXMoZGF0ZUZucy5zZXRIb3VycyhkYXRlRm5zLnN0YXJ0T2ZEYXkoZXZlbnRTdGFydCksIGRheVN0YXJ0LmhvdXIpLCBkYXlTdGFydC5taW51dGUpO1xyXG4gICAgY29uc3QgZW5kT2ZWaWV3OiBEYXRlID0gZGF0ZUZucy5zZXRNaW51dGVzKGRhdGVGbnMuc2V0SG91cnMoZGF0ZUZucy5zdGFydE9mTWludXRlKGV2ZW50U3RhcnQpLCBkYXlFbmQuaG91ciksIGRheUVuZC5taW51dGUpO1xyXG5cclxuICAgIHJldHVybiBkYXRlRm5zLmlzQWZ0ZXIoZXZlbnRFbmQsIHN0YXJ0T2ZWaWV3KSAmJiBkYXRlRm5zLmlzQmVmb3JlKGV2ZW50U3RhcnQsIGVuZE9mVmlldyk7XHJcbiAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFdlZWtEYXkoeyBkYXRlIH06IHsgZGF0ZTogRGF0ZSB9KTogV2Vla0RheSB7XHJcbiAgY29uc3QgdG9kYXk6IERhdGUgPSBkYXRlRm5zLnN0YXJ0T2ZEYXkobmV3IERhdGUoKSk7XHJcbiAgcmV0dXJuIHtcclxuICAgIGRhdGUsXHJcbiAgICBpc1Bhc3Q6IGRhdGUgPCB0b2RheSxcclxuICAgIGlzVG9kYXk6IGRhdGVGbnMuaXNTYW1lRGF5KGRhdGUsIHRvZGF5KSxcclxuICAgIGlzRnV0dXJlOiBkYXRlID4gdG9kYXksXHJcbiAgICBpc1dlZWtlbmQ6IFdFRUtFTkRfREFZX05VTUJFUlMuaW5kZXhPZihkYXRlRm5zLmdldERheShkYXRlKSkgPiAtMSxcclxuICB9O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0V2Vla1ZpZXdIZWFkZXIoe1xyXG4gIHZpZXdEYXRlLFxyXG4gIHdlZWtTdGFydHNPbixcclxuICBleGNsdWRlZCA9IFtdLFxyXG59OiB7XHJcbiAgdmlld0RhdGU6IERhdGU7XHJcbiAgd2Vla1N0YXJ0c09uOiBudW1iZXI7XHJcbiAgZXhjbHVkZWQ/OiBudW1iZXJbXTtcclxufSk6IFdlZWtEYXlbXSB7XHJcbiAgY29uc3Qgc3RhcnQ6IERhdGUgPSBkYXRlRm5zLnN0YXJ0T2ZXZWVrKHZpZXdEYXRlLCB7IHdlZWtTdGFydHNPbiB9KTtcclxuICBjb25zdCBkYXlzOiBXZWVrRGF5W10gPSBbXTtcclxuICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgREFZU19JTl9XRUVLOyBpKyspIHtcclxuICAgIGNvbnN0IGRhdGU6IERhdGUgPSBkYXRlRm5zLmFkZERheXMoc3RhcnQsIGkpO1xyXG4gICAgaWYgKCFleGNsdWRlZC5zb21lKChlKSA9PiBkYXRlLmdldERheSgpID09PSBlKSkge1xyXG4gICAgICBkYXlzLnB1c2goZ2V0V2Vla0RheSh7IGRhdGUgfSkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGRheXM7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRXZWVrVmlldyh7XHJcbiAgZXZlbnRzID0gW10sXHJcbiAgdmlld0RhdGUsXHJcbiAgd2Vla1N0YXJ0c09uLFxyXG4gIGV4Y2x1ZGVkID0gW10sXHJcbiAgaG91clNlZ21lbnRzLFxyXG4gIHNlZ21lbnRIZWlnaHQsXHJcbiAgZGF5U3RhcnQsXHJcbiAgZGF5RW5kLFxyXG59OiB7XHJcbiAgZXZlbnRzPzogQ2FsZW5kYXJFdmVudFtdO1xyXG4gIHZpZXdEYXRlOiBEYXRlO1xyXG4gIHdlZWtTdGFydHNPbjogbnVtYmVyO1xyXG4gIGV4Y2x1ZGVkPzogbnVtYmVyW107XHJcbiAgaG91clNlZ21lbnRzOiBudW1iZXI7XHJcbiAgc2VnbWVudEhlaWdodDogbnVtYmVyO1xyXG4gIGRheVN0YXJ0OiBhbnk7XHJcbiAgZGF5RW5kOiBhbnk7XHJcbn0pOiBXZWVrVmlld0V2ZW50Um93W10ge1xyXG4gIGlmICghZXZlbnRzKSB7XHJcbiAgICBldmVudHMgPSBbXTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHN0YXJ0T2ZWaWV3V2VlazogRGF0ZSA9IGRhdGVGbnMuc3RhcnRPZldlZWsodmlld0RhdGUsIHsgd2Vla1N0YXJ0c09uIH0pO1xyXG4gIGNvbnN0IGVuZE9mVmlld1dlZWs6IERhdGUgPSBkYXRlRm5zLmVuZE9mV2Vlayh2aWV3RGF0ZSwgeyB3ZWVrU3RhcnRzT24gfSk7XHJcbiAgY29uc3QgbWF4UmFuZ2U6IG51bWJlciA9IERBWVNfSU5fV0VFSyAtIGV4Y2x1ZGVkLmxlbmd0aDtcclxuXHJcbiAgY29uc3QgZXZlbnRzTWFwcGVkOiBXZWVrVmlld0V2ZW50W10gPSBnZXRFdmVudHNJblRpbWVSYW5nZShcclxuICAgIGdldEV2ZW50c0luUGVyaW9kKHsgZXZlbnRzLCBwZXJpb2RTdGFydDogc3RhcnRPZlZpZXdXZWVrLCBwZXJpb2RFbmQ6IGVuZE9mVmlld1dlZWsgfSksXHJcbiAgICBkYXlTdGFydCxcclxuICAgIGRheUVuZCxcclxuICApXHJcbiAgICAubWFwKChldmVudCkgPT4ge1xyXG4gICAgICBjb25zdCBvZmZzZXQ6IG51bWJlciA9IGdldFdlZWtWaWV3RXZlbnRPZmZzZXQoeyBldmVudCwgc3RhcnRPZldlZWs6IHN0YXJ0T2ZWaWV3V2VlaywgZXhjbHVkZWQgfSk7XHJcbiAgICAgIGNvbnN0IHNwYW46IG51bWJlciA9IDE7IC8vIGdldFdlZWtWaWV3RXZlbnRTcGFuKHsgZXZlbnQsIG9mZnNldCwgc3RhcnRPZldlZWs6IHN0YXJ0T2ZWaWV3V2VlaywgZXhjbHVkZWQgfSk7XHJcbiAgICAgIHJldHVybiB7IGV2ZW50LCBvZmZzZXQsIHNwYW4gfTtcclxuICAgIH0pXHJcbiAgICAuZmlsdGVyKChlKSA9PiBlLm9mZnNldCA8IG1heFJhbmdlKVxyXG4gICAgLmZpbHRlcigoZSkgPT4gZS5zcGFuID4gMClcclxuICAgIC5tYXAoKGVudHJ5KSA9PiAoe1xyXG4gICAgICBldmVudDogZW50cnkuZXZlbnQsXHJcbiAgICAgIG9mZnNldDogZW50cnkub2Zmc2V0LFxyXG4gICAgICBzcGFuOiBlbnRyeS5zcGFuLFxyXG4gICAgICBzdGFydHNCZWZvcmVXZWVrOiBlbnRyeS5ldmVudC5zdGFydCA8IHN0YXJ0T2ZWaWV3V2VlayxcclxuICAgICAgZW5kc0FmdGVyV2VlazogKGVudHJ5LmV2ZW50LmVuZCB8fCBlbnRyeS5ldmVudC5zdGFydCkgPiBlbmRPZlZpZXdXZWVrLFxyXG4gICAgICB0b3A6IDAsXHJcbiAgICB9KSlcclxuICAgIC5zb3J0KFxyXG4gICAgICAoaXRlbUEsIGl0ZW1CKTogbnVtYmVyID0+IHtcclxuICAgICAgICBjb25zdCBzdGFydFNlY29uZHNEaWZmOiBudW1iZXIgPSBkYXRlRm5zLmRpZmZlcmVuY2VJblNlY29uZHMoaXRlbUEuZXZlbnQuc3RhcnQsIGl0ZW1CLmV2ZW50LnN0YXJ0KTtcclxuICAgICAgICBpZiAoc3RhcnRTZWNvbmRzRGlmZiA9PT0gMCkge1xyXG4gICAgICAgICAgcmV0dXJuIGRhdGVGbnMuZGlmZmVyZW5jZUluU2Vjb25kcyhpdGVtQi5ldmVudC5lbmQgfHwgaXRlbUIuZXZlbnQuc3RhcnQsIGl0ZW1BLmV2ZW50LmVuZCB8fCBpdGVtQS5ldmVudC5zdGFydCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBzdGFydFNlY29uZHNEaWZmO1xyXG4gICAgICB9LFxyXG4gICAgKVxyXG4gICAgLm1hcCgoZW50cnk6IFdlZWtWaWV3RXZlbnQpID0+IHtcclxuICAgICAgY29uc3Qgc3RhcnRPZlZpZXc6IERhdGUgPSBkYXRlRm5zLnNldE1pbnV0ZXMoZGF0ZUZucy5zZXRIb3VycyhkYXRlRm5zLnN0YXJ0T2ZEYXkoZW50cnkuZXZlbnQuc3RhcnQpLCBkYXlTdGFydC5ob3VyKSwgZGF5U3RhcnQubWludXRlKTtcclxuICAgICAgY29uc3QgZW5kT2ZWaWV3OiBEYXRlID0gZGF0ZUZucy5zZXRNaW51dGVzKFxyXG4gICAgICAgIGRhdGVGbnMuc2V0SG91cnMoZGF0ZUZucy5zdGFydE9mTWludXRlKGRhdGVGbnMuZW5kT2ZEYXkoZW50cnkuZXZlbnQuc3RhcnQpKSwgZGF5RW5kLmhvdXIpLFxyXG4gICAgICAgIGRheUVuZC5taW51dGUsXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBjb25zdCBldmVudFN0YXJ0OiBEYXRlID0gZW50cnkuZXZlbnQuc3RhcnQ7XHJcbiAgICAgIGNvbnN0IGV2ZW50RW5kOiBEYXRlID0gZW50cnkuZXZlbnQuZW5kIHx8IGV2ZW50U3RhcnQ7XHJcblxyXG4gICAgICBjb25zdCBob3VySGVpZ2h0TW9kaWZpZXI6IG51bWJlciA9IChob3VyU2VnbWVudHMgKiBzZWdtZW50SGVpZ2h0KSAvIE1JTlVURVNfSU5fSE9VUjtcclxuXHJcbiAgICAgIGlmIChldmVudFN0YXJ0ID4gc3RhcnRPZlZpZXcpIHtcclxuICAgICAgICBlbnRyeS50b3AgKz0gZGF0ZUZucy5kaWZmZXJlbmNlSW5NaW51dGVzKGV2ZW50U3RhcnQsIHN0YXJ0T2ZWaWV3KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgZW50cnkudG9wICo9IGhvdXJIZWlnaHRNb2RpZmllcjtcclxuXHJcbiAgICAgIGNvbnN0IHN0YXJ0c0JlZm9yZURheTogYm9vbGVhbiA9IGV2ZW50U3RhcnQgPCBzdGFydE9mVmlldztcclxuICAgICAgY29uc3QgZW5kc0FmdGVyRGF5OiBib29sZWFuID0gZXZlbnRFbmQgPiBlbmRPZlZpZXc7XHJcblxyXG4gICAgICBjb25zdCBzdGFydERhdGU6IERhdGUgPSBzdGFydHNCZWZvcmVEYXkgPyBzdGFydE9mVmlldyA6IGV2ZW50U3RhcnQ7XHJcbiAgICAgIGNvbnN0IGVuZERhdGU6IERhdGUgPSBlbmRzQWZ0ZXJEYXkgPyBlbmRPZlZpZXcgOiBldmVudEVuZDtcclxuXHJcbiAgICAgIGxldCBoZWlnaHQ6IG51bWJlciA9IGRhdGVGbnMuZGlmZmVyZW5jZUluTWludXRlcyhlbmREYXRlLCBzdGFydERhdGUpO1xyXG5cclxuICAgICAgaWYgKCFlbnRyeS5ldmVudC5lbmQpIHtcclxuICAgICAgICBoZWlnaHQgPSBzZWdtZW50SGVpZ2h0O1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGhlaWdodCAqPSBob3VySGVpZ2h0TW9kaWZpZXI7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGVudHJ5LmhlaWdodCA9IGhlaWdodDtcclxuXHJcbiAgICAgIHJldHVybiBlbnRyeTtcclxuICAgIH0pO1xyXG5cclxuICBjb25zdCBldmVudFJvd3M6IFdlZWtWaWV3RXZlbnRSb3dbXSA9IFtdO1xyXG4gIGNvbnN0IGFsbG9jYXRlZEV2ZW50czogV2Vla1ZpZXdFdmVudFtdID0gW107XHJcblxyXG4gIGV2ZW50c01hcHBlZC5mb3JFYWNoKChldmVudDogV2Vla1ZpZXdFdmVudCwgaW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgaWYgKGFsbG9jYXRlZEV2ZW50cy5pbmRleE9mKGV2ZW50KSA9PT0gLTEpIHtcclxuICAgICAgYWxsb2NhdGVkRXZlbnRzLnB1c2goZXZlbnQpO1xyXG5cclxuICAgICAgY29uc3Qgb3RoZXJSb3dFdmVudHM6IFdlZWtWaWV3RXZlbnRbXSA9IGV2ZW50c01hcHBlZC5zbGljZShpbmRleCArIDEpLmZpbHRlcigobmV4dEV2ZW50KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIG5leHRFdmVudC50b3AgPT09IGV2ZW50LnRvcCAmJiBuZXh0RXZlbnQub2Zmc2V0ID09PSBldmVudC5vZmZzZXQ7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgaWYgKG90aGVyUm93RXZlbnRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCB0b3RhbEV2ZW50c0ZvclJvdyA9IG90aGVyUm93RXZlbnRzLmxlbmd0aCArIDE7XHJcblxyXG4gICAgICAgIGV2ZW50LnNwYW4gPSAxIC8gdG90YWxFdmVudHNGb3JSb3c7XHJcblxyXG4gICAgICAgIGxldCBuZXh0T2Zmc2V0ID0gZXZlbnQuc3BhbiArIGV2ZW50Lm9mZnNldDtcclxuXHJcbiAgICAgICAgb3RoZXJSb3dFdmVudHMuZm9yRWFjaCgobmV4dEV2ZW50OiBXZWVrVmlld0V2ZW50KSA9PiB7XHJcbiAgICAgICAgICBuZXh0RXZlbnQub2Zmc2V0ID0gbmV4dE9mZnNldDtcclxuICAgICAgICAgIG5leHRFdmVudC5zcGFuID0gZXZlbnQuc3BhbjtcclxuICAgICAgICAgIG5leHRPZmZzZXQgPSBuZXh0RXZlbnQuc3BhbiArIG5leHRFdmVudC5vZmZzZXQ7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGFsbG9jYXRlZEV2ZW50cy5wdXNoKC4uLm90aGVyUm93RXZlbnRzKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgZXZlbnRSb3dzLnB1c2goe1xyXG4gICAgICAgIHJvdzogW2V2ZW50LCAuLi5vdGhlclJvd0V2ZW50c10sXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICByZXR1cm4gZXZlbnRSb3dzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0TW9udGhWaWV3KHtcclxuICBldmVudHMgPSBbXSxcclxuICB2aWV3RGF0ZSxcclxuICB3ZWVrU3RhcnRzT24sXHJcbiAgZXhjbHVkZWQgPSBbXSxcclxufToge1xyXG4gIGV2ZW50cz86IENhbGVuZGFyRXZlbnRbXTtcclxuICB2aWV3RGF0ZTogRGF0ZTtcclxuICB3ZWVrU3RhcnRzT246IG51bWJlcjtcclxuICBleGNsdWRlZD86IG51bWJlcltdO1xyXG59KTogTW9udGhWaWV3IHtcclxuICBpZiAoIWV2ZW50cykge1xyXG4gICAgZXZlbnRzID0gW107XHJcbiAgfVxyXG5cclxuICBjb25zdCBzdGFydDogRGF0ZSA9IGRhdGVGbnMuc3RhcnRPZldlZWsoZGF0ZUZucy5zdGFydE9mTW9udGgodmlld0RhdGUpLCB7IHdlZWtTdGFydHNPbiB9KTtcclxuICBjb25zdCBlbmQ6IERhdGUgPSBkYXRlRm5zLmVuZE9mV2VlayhkYXRlRm5zLmVuZE9mTW9udGgodmlld0RhdGUpLCB7IHdlZWtTdGFydHNPbiB9KTtcclxuICBjb25zdCBldmVudHNJbk1vbnRoOiBDYWxlbmRhckV2ZW50W10gPSBnZXRFdmVudHNJblBlcmlvZCh7XHJcbiAgICBldmVudHMsXHJcbiAgICBwZXJpb2RTdGFydDogc3RhcnQsXHJcbiAgICBwZXJpb2RFbmQ6IGVuZCxcclxuICB9KTtcclxuICBjb25zdCBkYXlzOiBNb250aFZpZXdEYXlbXSA9IFtdO1xyXG4gIGZvciAobGV0IGk6IG51bWJlciA9IDA7IGkgPCBkYXRlRm5zLmRpZmZlcmVuY2VJbkRheXMoZW5kLCBzdGFydCkgKyAxOyBpKyspIHtcclxuICAgIGNvbnN0IGRhdGU6IERhdGUgPSBkYXRlRm5zLmFkZERheXMoc3RhcnQsIGkpO1xyXG4gICAgaWYgKCFleGNsdWRlZC5zb21lKChlKSA9PiBkYXRlLmdldERheSgpID09PSBlKSkge1xyXG4gICAgICBjb25zdCBkYXk6IE1vbnRoVmlld0RheSA9IGdldFdlZWtEYXkoeyBkYXRlIH0pIGFzIE1vbnRoVmlld0RheTtcclxuICAgICAgY29uc3QgY2FsRXZlbnRzOiBDYWxlbmRhckV2ZW50W10gPSBnZXRFdmVudHNJblBlcmlvZCh7XHJcbiAgICAgICAgZXZlbnRzOiBldmVudHNJbk1vbnRoLFxyXG4gICAgICAgIHBlcmlvZFN0YXJ0OiBkYXRlRm5zLnN0YXJ0T2ZEYXkoZGF0ZSksXHJcbiAgICAgICAgcGVyaW9kRW5kOiBkYXRlRm5zLmVuZE9mRGF5KGRhdGUpLFxyXG4gICAgICB9KTtcclxuICAgICAgZGF5LmluTW9udGggPSBkYXRlRm5zLmlzU2FtZU1vbnRoKGRhdGUsIHZpZXdEYXRlKTtcclxuICAgICAgZGF5LmV2ZW50cyA9IGNhbEV2ZW50cztcclxuICAgICAgZGF5LmJhZGdlVG90YWwgPSBjYWxFdmVudHMubGVuZ3RoO1xyXG4gICAgICBkYXlzLnB1c2goZGF5KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnN0IHRvdGFsRGF5c1Zpc2libGVJbldlZWs6IG51bWJlciA9IERBWVNfSU5fV0VFSyAtIGV4Y2x1ZGVkLmxlbmd0aDtcclxuICBjb25zdCByb3dzOiBudW1iZXIgPSBNYXRoLmZsb29yKGRheXMubGVuZ3RoIC8gdG90YWxEYXlzVmlzaWJsZUluV2Vlayk7XHJcbiAgY29uc3Qgcm93T2Zmc2V0czogbnVtYmVyW10gPSBbXTtcclxuICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgcm93czsgaSsrKSB7XHJcbiAgICByb3dPZmZzZXRzLnB1c2goaSAqIHRvdGFsRGF5c1Zpc2libGVJbldlZWspO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIHJvd09mZnNldHMsXHJcbiAgICB0b3RhbERheXNWaXNpYmxlSW5XZWVrLFxyXG4gICAgZGF5cyxcclxuICB9O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGF5Vmlldyh7IGV2ZW50cyA9IFtdLCB2aWV3RGF0ZSwgaG91clNlZ21lbnRzLCBkYXlTdGFydCwgZGF5RW5kLCBldmVudFdpZHRoLCBzZWdtZW50SGVpZ2h0IH06IEdldERheVZpZXdBcmdzKTogRGF5VmlldyB7XHJcbiAgaWYgKCFldmVudHMpIHtcclxuICAgIGV2ZW50cyA9IFtdO1xyXG4gIH1cclxuXHJcbiAgY29uc3Qgc3RhcnRPZlZpZXc6IERhdGUgPSBkYXRlRm5zLnNldE1pbnV0ZXMoZGF0ZUZucy5zZXRIb3VycyhkYXRlRm5zLnN0YXJ0T2ZEYXkodmlld0RhdGUpLCBkYXlTdGFydC5ob3VyKSwgZGF5U3RhcnQubWludXRlKTtcclxuICBjb25zdCBlbmRPZlZpZXc6IERhdGUgPSBkYXRlRm5zLnNldE1pbnV0ZXMoXHJcbiAgICBkYXRlRm5zLnNldEhvdXJzKGRhdGVGbnMuc3RhcnRPZk1pbnV0ZShkYXRlRm5zLmVuZE9mRGF5KHZpZXdEYXRlKSksIGRheUVuZC5ob3VyKSxcclxuICAgIGRheUVuZC5taW51dGUsXHJcbiAgKTtcclxuICBjb25zdCBwcmV2aW91c0RheUV2ZW50czogRGF5Vmlld0V2ZW50W10gPSBbXTtcclxuXHJcbiAgY29uc3QgZGF5Vmlld0V2ZW50czogRGF5Vmlld0V2ZW50W10gPSBnZXRFdmVudHNJblRpbWVSYW5nZShcclxuICAgIGdldEV2ZW50c0luUGVyaW9kKHtcclxuICAgICAgZXZlbnRzOiBldmVudHMuZmlsdGVyKChldmVudDogQ2FsZW5kYXJFdmVudCkgPT4gIWV2ZW50LmFsbERheSksXHJcbiAgICAgIHBlcmlvZFN0YXJ0OiBzdGFydE9mVmlldyxcclxuICAgICAgcGVyaW9kRW5kOiBlbmRPZlZpZXcsXHJcbiAgICB9KSxcclxuICAgIGRheVN0YXJ0LFxyXG4gICAgZGF5RW5kLFxyXG4gIClcclxuICAgIC5zb3J0KChldmVudEE6IENhbGVuZGFyRXZlbnQsIGV2ZW50QjogQ2FsZW5kYXJFdmVudCkgPT4ge1xyXG4gICAgICByZXR1cm4gZXZlbnRBLnN0YXJ0LnZhbHVlT2YoKSAtIGV2ZW50Qi5zdGFydC52YWx1ZU9mKCk7XHJcbiAgICB9KVxyXG4gICAgLm1hcCgoZXZlbnQ6IENhbGVuZGFyRXZlbnQpID0+IHtcclxuICAgICAgY29uc3QgZXZlbnRTdGFydDogRGF0ZSA9IGV2ZW50LnN0YXJ0O1xyXG4gICAgICBjb25zdCBldmVudEVuZDogRGF0ZSA9IGV2ZW50LmVuZCB8fCBldmVudFN0YXJ0O1xyXG4gICAgICBjb25zdCBzdGFydHNCZWZvcmVEYXk6IGJvb2xlYW4gPSBldmVudFN0YXJ0IDwgc3RhcnRPZlZpZXc7XHJcbiAgICAgIGNvbnN0IGVuZHNBZnRlckRheTogYm9vbGVhbiA9IGV2ZW50RW5kID4gZW5kT2ZWaWV3O1xyXG4gICAgICBjb25zdCBob3VySGVpZ2h0TW9kaWZpZXI6IG51bWJlciA9IChob3VyU2VnbWVudHMgKiBzZWdtZW50SGVpZ2h0KSAvIE1JTlVURVNfSU5fSE9VUjtcclxuXHJcbiAgICAgIGxldCB0b3A6IG51bWJlciA9IDA7XHJcblxyXG4gICAgICBpZiAoZXZlbnRTdGFydCA+IHN0YXJ0T2ZWaWV3KSB7XHJcbiAgICAgICAgdG9wICs9IGRhdGVGbnMuZGlmZmVyZW5jZUluTWludXRlcyhldmVudFN0YXJ0LCBzdGFydE9mVmlldyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRvcCAqPSBob3VySGVpZ2h0TW9kaWZpZXI7XHJcblxyXG4gICAgICBjb25zdCBzdGFydERhdGU6IERhdGUgPSBzdGFydHNCZWZvcmVEYXkgPyBzdGFydE9mVmlldyA6IGV2ZW50U3RhcnQ7XHJcbiAgICAgIGNvbnN0IGVuZERhdGU6IERhdGUgPSBlbmRzQWZ0ZXJEYXkgPyBlbmRPZlZpZXcgOiBldmVudEVuZDtcclxuXHJcbiAgICAgIGxldCBoZWlnaHQ6IG51bWJlciA9IGRhdGVGbnMuZGlmZmVyZW5jZUluTWludXRlcyhlbmREYXRlLCBzdGFydERhdGUpO1xyXG5cclxuICAgICAgaWYgKCFldmVudC5lbmQpIHtcclxuICAgICAgICBoZWlnaHQgPSBzZWdtZW50SGVpZ2h0O1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGhlaWdodCAqPSBob3VySGVpZ2h0TW9kaWZpZXI7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGJvdHRvbTogbnVtYmVyID0gdG9wICsgaGVpZ2h0O1xyXG5cclxuICAgICAgY29uc3Qgb3ZlcmxhcHBpbmdQcmV2aW91c0V2ZW50czogRGF5Vmlld0V2ZW50W10gPSBwcmV2aW91c0RheUV2ZW50cy5maWx0ZXIoKHByZXZpb3VzRXZlbnQ6IERheVZpZXdFdmVudCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHByZXZpb3VzRXZlbnRUb3A6IG51bWJlciA9IHByZXZpb3VzRXZlbnQudG9wO1xyXG4gICAgICAgIGNvbnN0IHByZXZpb3VzRXZlbnRCb3R0b206IG51bWJlciA9IHByZXZpb3VzRXZlbnQudG9wICsgcHJldmlvdXNFdmVudC5oZWlnaHQ7XHJcblxyXG4gICAgICAgIGlmICh0b3AgPCBwcmV2aW91c0V2ZW50Qm90dG9tICYmIHByZXZpb3VzRXZlbnRCb3R0b20gPCBib3R0b20pIHtcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSBpZiAocHJldmlvdXNFdmVudFRvcCA8PSB0b3AgJiYgYm90dG9tIDw9IHByZXZpb3VzRXZlbnRCb3R0b20pIHtcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGxldCBsZWZ0OiBudW1iZXIgPSAwO1xyXG5cclxuICAgICAgd2hpbGUgKG92ZXJsYXBwaW5nUHJldmlvdXNFdmVudHMuc29tZSgocHJldmlvdXNFdmVudCkgPT4gcHJldmlvdXNFdmVudC5sZWZ0ID09PSBsZWZ0KSkge1xyXG4gICAgICAgIGxlZnQgKz0gZXZlbnRXaWR0aDtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgZGF5RXZlbnQ6IERheVZpZXdFdmVudCA9IHtcclxuICAgICAgICBldmVudCxcclxuICAgICAgICBoZWlnaHQsXHJcbiAgICAgICAgd2lkdGg6IGV2ZW50V2lkdGgsXHJcbiAgICAgICAgdG9wLFxyXG4gICAgICAgIGxlZnQsXHJcbiAgICAgICAgc3RhcnRzQmVmb3JlRGF5LFxyXG4gICAgICAgIGVuZHNBZnRlckRheSxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIGlmIChoZWlnaHQgPiAwKSB7XHJcbiAgICAgICAgcHJldmlvdXNEYXlFdmVudHMucHVzaChkYXlFdmVudCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiBkYXlFdmVudDtcclxuICAgIH0pXHJcbiAgICAuZmlsdGVyKChkYXlFdmVudDogRGF5Vmlld0V2ZW50KSA9PiBkYXlFdmVudC5oZWlnaHQgPiAwKTtcclxuXHJcbiAgY29uc3Qgd2lkdGg6IG51bWJlciA9IE1hdGgubWF4KC4uLmRheVZpZXdFdmVudHMubWFwKChldmVudDogRGF5Vmlld0V2ZW50KSA9PiBldmVudC5sZWZ0ICsgZXZlbnQud2lkdGgpKTtcclxuICBjb25zdCBhbGxEYXlFdmVudHM6IENhbGVuZGFyRXZlbnRbXSA9IGdldEV2ZW50c0luUGVyaW9kKHtcclxuICAgIGV2ZW50czogZXZlbnRzLmZpbHRlcigoZXZlbnQ6IENhbGVuZGFyRXZlbnQpID0+IGV2ZW50LmFsbERheSksXHJcbiAgICBwZXJpb2RTdGFydDogZGF0ZUZucy5zdGFydE9mRGF5KHN0YXJ0T2ZWaWV3KSxcclxuICAgIHBlcmlvZEVuZDogZGF0ZUZucy5lbmRPZkRheShlbmRPZlZpZXcpLFxyXG4gIH0pO1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgZXZlbnRzOiBkYXlWaWV3RXZlbnRzLFxyXG4gICAgd2lkdGgsXHJcbiAgICBhbGxEYXlFdmVudHMsXHJcbiAgfTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldERheVZpZXdIb3VyR3JpZCh7XHJcbiAgdmlld0RhdGUsXHJcbiAgaG91clNlZ21lbnRzLFxyXG4gIGRheVN0YXJ0LFxyXG4gIGRheUVuZCxcclxufToge1xyXG4gIHZpZXdEYXRlOiBEYXRlO1xyXG4gIGhvdXJTZWdtZW50czogbnVtYmVyO1xyXG4gIGRheVN0YXJ0OiBhbnk7XHJcbiAgZGF5RW5kOiBhbnk7XHJcbn0pOiBEYXlWaWV3SG91cltdIHtcclxuICBjb25zdCBob3VyczogRGF5Vmlld0hvdXJbXSA9IFtdO1xyXG5cclxuICBjb25zdCBzdGFydE9mVmlldzogRGF0ZSA9IGRhdGVGbnMuc2V0TWludXRlcyhkYXRlRm5zLnNldEhvdXJzKGRhdGVGbnMuc3RhcnRPZkRheSh2aWV3RGF0ZSksIGRheVN0YXJ0LmhvdXIpLCBkYXlTdGFydC5taW51dGUpO1xyXG4gIGNvbnN0IGVuZE9mVmlldzogRGF0ZSA9IGRhdGVGbnMuc2V0TWludXRlcyhcclxuICAgIGRhdGVGbnMuc2V0SG91cnMoZGF0ZUZucy5zdGFydE9mTWludXRlKGRhdGVGbnMuZW5kT2ZEYXkodmlld0RhdGUpKSwgZGF5RW5kLmhvdXIpLFxyXG4gICAgZGF5RW5kLm1pbnV0ZSxcclxuICApO1xyXG4gIGNvbnN0IHNlZ21lbnREdXJhdGlvbjogbnVtYmVyID0gTUlOVVRFU19JTl9IT1VSIC8gaG91clNlZ21lbnRzO1xyXG4gIGNvbnN0IHN0YXJ0T2ZWaWV3RGF5OiBEYXRlID0gZGF0ZUZucy5zdGFydE9mRGF5KHZpZXdEYXRlKTtcclxuXHJcbiAgZm9yIChsZXQgaTogbnVtYmVyID0gMDsgaSA8IEhPVVJTX0lOX0RBWTsgaSsrKSB7XHJcbiAgICBjb25zdCBzZWdtZW50czogRGF5Vmlld0hvdXJTZWdtZW50W10gPSBbXTtcclxuICAgIGZvciAobGV0IGo6IG51bWJlciA9IDA7IGogPCBob3VyU2VnbWVudHM7IGorKykge1xyXG4gICAgICBjb25zdCBkYXRlOiBEYXRlID0gZGF0ZUZucy5hZGRNaW51dGVzKGRhdGVGbnMuYWRkSG91cnMoc3RhcnRPZlZpZXdEYXksIGkpLCBqICogc2VnbWVudER1cmF0aW9uKTtcclxuICAgICAgaWYgKGRhdGUgPj0gc3RhcnRPZlZpZXcgJiYgZGF0ZSA8IGVuZE9mVmlldykge1xyXG4gICAgICAgIHNlZ21lbnRzLnB1c2goe1xyXG4gICAgICAgICAgZGF0ZSxcclxuICAgICAgICAgIGlzU3RhcnQ6IGogPT09IDAsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmIChzZWdtZW50cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGhvdXJzLnB1c2goeyBzZWdtZW50cyB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBob3VycztcclxufVxyXG4iXX0=