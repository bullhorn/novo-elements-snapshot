import { addHours, addMinutes, differenceInMinutes, getDay } from 'date-fns';
import { DateUtil } from '../date';
const WEEKEND_DAY_NUMBERS = [0, 6];
const DAYS_IN_WEEK = 7;
const HOURS_IN_DAY = 24;
const MINUTES_IN_HOUR = 60;
export var CalendarEventResponse;
(function (CalendarEventResponse) {
    CalendarEventResponse[CalendarEventResponse["Maybe"] = 0] = "Maybe";
    CalendarEventResponse[CalendarEventResponse["Accepted"] = 1] = "Accepted";
    CalendarEventResponse[CalendarEventResponse["Rejected"] = 2] = "Rejected";
})(CalendarEventResponse || (CalendarEventResponse = {}));
function getExcludedDays({ startDate, days, excluded }) {
    if (excluded.length < 1) {
        return 0;
    }
    let day = startDate.getDay();
    let reduce = 0;
    for (let i = 0; i < days; i++) {
        if (day === DAYS_IN_WEEK) {
            day = 0;
        }
        if (excluded.some((e) => e === day)) {
            reduce++;
        }
        day++;
    }
    return reduce;
}
function getWeekViewEventSpan({ event, offset, startOfWeek, excluded, }) {
    const begin = event.start < startOfWeek ? startOfWeek : event.start;
    let span = 1;
    if (event.end) {
        span = DateUtil.differenceInDays(addMinutes(DateUtil.endOfDay(event.end), 1), DateUtil.startOfDay(begin));
    }
    const totalLength = offset + span;
    if (totalLength > DAYS_IN_WEEK) {
        span = DAYS_IN_WEEK - offset;
    }
    return span - getExcludedDays({ startDate: begin, days: span, excluded });
}
export function getWeekViewEventOffset({ event, startOfWeek, excluded = [], }) {
    if (event.start < startOfWeek) {
        return 0;
    }
    const distance = DateUtil.differenceInDays(event.start, startOfWeek);
    return distance - getExcludedDays({ startDate: startOfWeek, days: distance, excluded });
}
function isEventIsPeriod({ event, periodStart, periodEnd }) {
    const eventStart = event.start;
    const eventEnd = event.end || event.start;
    if (eventStart > periodStart && eventStart < periodEnd) {
        return true;
    }
    if (eventEnd > periodStart && eventEnd < periodEnd) {
        return true;
    }
    if (eventStart < periodStart && eventEnd > periodEnd) {
        return true;
    }
    if (DateUtil.isSameSecond(eventStart, periodStart) || DateUtil.isSameSecond(eventStart, periodEnd)) {
        return true;
    }
    if (DateUtil.isSameSecond(eventEnd, periodStart) || DateUtil.isSameSecond(eventEnd, periodEnd)) {
        return true;
    }
    return false;
}
function getEventsInPeriod({ events, periodStart, periodEnd }) {
    return events.filter((event) => isEventIsPeriod({ event, periodStart, periodEnd }));
}
function getEventsInTimeRange(events, dayStart, dayEnd) {
    return events.filter((event) => {
        const eventStart = event.start;
        const eventEnd = event.end || eventStart;
        const startOfView = DateUtil.setMinutes(DateUtil.setHours(DateUtil.startOfDay(eventStart), dayStart.hour), dayStart.minute);
        const endOfView = DateUtil.setMinutes(DateUtil.setHours(DateUtil.startOfMinute(eventStart), dayEnd.hour), dayEnd.minute);
        return DateUtil.isAfter(eventEnd, startOfView) && DateUtil.isBefore(eventStart, endOfView);
    });
}
function getWeekDay({ date }) {
    const today = DateUtil.startOfDay(new Date());
    return {
        date,
        isPast: date < today,
        isToday: DateUtil.isSameDay(date, today),
        isFuture: date > today,
        isWeekend: WEEKEND_DAY_NUMBERS.indexOf(getDay(date)) > -1,
    };
}
export function getWeekViewHeader({ viewDate, weekStartsOn, excluded = [], }) {
    const start = DateUtil.startOfWeek(viewDate, { weekStartsOn });
    const days = [];
    for (let i = 0; i < DAYS_IN_WEEK; i++) {
        const date = DateUtil.addDays(start, i);
        if (!excluded.some((e) => date.getDay() === e)) {
            days.push(getWeekDay({ date }));
        }
    }
    return days;
}
export function getWeekView({ events = [], viewDate, weekStartsOn, excluded = [], hourSegments, segmentHeight, dayStart, dayEnd, }) {
    if (!events) {
        events = [];
    }
    const startOfViewWeek = DateUtil.startOfWeek(viewDate, { weekStartsOn });
    const endOfViewWeek = DateUtil.endOfWeek(viewDate, { weekStartsOn });
    const maxRange = DAYS_IN_WEEK - excluded.length;
    const eventsMapped = getEventsInTimeRange(getEventsInPeriod({ events, periodStart: startOfViewWeek, periodEnd: endOfViewWeek }), dayStart, dayEnd)
        .map((event) => {
        const offset = getWeekViewEventOffset({ event, startOfWeek: startOfViewWeek, excluded });
        const span = 1; // getWeekViewEventSpan({ event, offset, startOfWeek: startOfViewWeek, excluded });
        return { event, offset, span };
    })
        .filter((e) => e.offset < maxRange)
        .filter((e) => e.span > 0)
        .map((entry) => ({
        event: entry.event,
        offset: entry.offset,
        span: entry.span,
        startsBeforeWeek: entry.event.start < startOfViewWeek,
        endsAfterWeek: (entry.event.end || entry.event.start) > endOfViewWeek,
        top: 0,
    }))
        .sort((itemA, itemB) => {
        const startSecondsDiff = DateUtil.differenceInSeconds(itemA.event.start, itemB.event.start);
        if (startSecondsDiff === 0) {
            return DateUtil.differenceInSeconds(itemB.event.end || itemB.event.start, itemA.event.end || itemA.event.start);
        }
        return startSecondsDiff;
    })
        .map((entry) => {
        const startOfView = DateUtil.setMinutes(DateUtil.setHours(DateUtil.startOfDay(entry.event.start), dayStart.hour), dayStart.minute);
        const endOfView = DateUtil.setMinutes(DateUtil.setHours(DateUtil.startOfMinute(DateUtil.endOfDay(entry.event.start)), dayEnd.hour), dayEnd.minute);
        const eventStart = entry.event.start;
        const eventEnd = entry.event.end || eventStart;
        const hourHeightModifier = (hourSegments * segmentHeight) / MINUTES_IN_HOUR;
        if (eventStart > startOfView) {
            entry.top += differenceInMinutes(eventStart, startOfView);
        }
        entry.top *= hourHeightModifier;
        const startsBeforeDay = eventStart < startOfView;
        const endsAfterDay = eventEnd > endOfView;
        const startDate = startsBeforeDay ? startOfView : eventStart;
        const endDate = endsAfterDay ? endOfView : eventEnd;
        let height = differenceInMinutes(endDate, startDate);
        if (!entry.event.end) {
            height = segmentHeight;
        }
        else {
            height *= hourHeightModifier;
        }
        entry.height = height;
        return entry;
    });
    const eventRows = [];
    const allocatedEvents = [];
    eventsMapped.forEach((event, index) => {
        if (allocatedEvents.indexOf(event) === -1) {
            allocatedEvents.push(event);
            const otherRowEvents = eventsMapped.slice(index + 1).filter((nextEvent) => {
                return nextEvent.top === event.top && nextEvent.offset === event.offset;
            });
            if (otherRowEvents.length > 0) {
                const totalEventsForRow = otherRowEvents.length + 1;
                event.span = 1 / totalEventsForRow;
                let nextOffset = event.span + event.offset;
                otherRowEvents.forEach((nextEvent) => {
                    nextEvent.offset = nextOffset;
                    nextEvent.span = event.span;
                    nextOffset = nextEvent.span + nextEvent.offset;
                });
                allocatedEvents.push(...otherRowEvents);
            }
            eventRows.push({
                row: [event, ...otherRowEvents],
            });
        }
    });
    return eventRows;
}
export function getMonthView({ events = [], viewDate, weekStartsOn, excluded = [], }) {
    if (!events) {
        events = [];
    }
    const start = DateUtil.startOfWeek(DateUtil.startOfMonth(viewDate), { weekStartsOn });
    const end = DateUtil.endOfWeek(DateUtil.endOfMonth(viewDate), { weekStartsOn });
    const eventsInMonth = getEventsInPeriod({
        events,
        periodStart: start,
        periodEnd: end,
    });
    const days = [];
    for (let i = 0; i < DateUtil.differenceInDays(end, start) + 1; i++) {
        const date = DateUtil.addDays(start, i);
        if (!excluded.some((e) => date.getDay() === e)) {
            const day = getWeekDay({ date });
            const calEvents = getEventsInPeriod({
                events: eventsInMonth,
                periodStart: DateUtil.startOfDay(date),
                periodEnd: DateUtil.endOfDay(date),
            });
            day.inMonth = DateUtil.isSameMonth(date, viewDate);
            day.events = calEvents;
            day.badgeTotal = calEvents.length;
            days.push(day);
        }
    }
    const totalDaysVisibleInWeek = DAYS_IN_WEEK - excluded.length;
    const rows = Math.floor(days.length / totalDaysVisibleInWeek);
    const rowOffsets = [];
    for (let i = 0; i < rows; i++) {
        rowOffsets.push(i * totalDaysVisibleInWeek);
    }
    return {
        rowOffsets,
        totalDaysVisibleInWeek,
        days,
    };
}
export function getDayView({ events = [], viewDate, hourSegments, dayStart, dayEnd, eventWidth, segmentHeight }) {
    if (!events) {
        events = [];
    }
    const startOfView = DateUtil.setMinutes(DateUtil.setHours(DateUtil.startOfDay(viewDate), dayStart.hour), dayStart.minute);
    const endOfView = DateUtil.setMinutes(DateUtil.setHours(DateUtil.startOfMinute(DateUtil.endOfDay(viewDate)), dayEnd.hour), dayEnd.minute);
    const previousDayEvents = [];
    const dayViewEvents = getEventsInTimeRange(getEventsInPeriod({
        events: events.filter((event) => !event.allDay),
        periodStart: startOfView,
        periodEnd: endOfView,
    }), dayStart, dayEnd)
        .sort((eventA, eventB) => {
        return eventA.start.valueOf() - eventB.start.valueOf();
    })
        .map((event) => {
        const eventStart = event.start;
        const eventEnd = event.end || eventStart;
        const startsBeforeDay = eventStart < startOfView;
        const endsAfterDay = eventEnd > endOfView;
        const hourHeightModifier = (hourSegments * segmentHeight) / MINUTES_IN_HOUR;
        let top = 0;
        if (eventStart > startOfView) {
            top += differenceInMinutes(eventStart, startOfView);
        }
        top *= hourHeightModifier;
        const startDate = startsBeforeDay ? startOfView : eventStart;
        const endDate = endsAfterDay ? endOfView : eventEnd;
        let height = differenceInMinutes(endDate, startDate);
        if (!event.end) {
            height = segmentHeight;
        }
        else {
            height *= hourHeightModifier;
        }
        const bottom = top + height;
        const overlappingPreviousEvents = previousDayEvents.filter((previousEvent) => {
            const previousEventTop = previousEvent.top;
            const previousEventBottom = previousEvent.top + previousEvent.height;
            if (top < previousEventBottom && previousEventBottom < bottom) {
                return true;
            }
            else if (previousEventTop <= top && bottom <= previousEventBottom) {
                return true;
            }
            return false;
        });
        let left = 0;
        while (overlappingPreviousEvents.some((previousEvent) => previousEvent.left === left)) {
            left += eventWidth;
        }
        const dayEvent = {
            event,
            height,
            width: eventWidth,
            top,
            left,
            startsBeforeDay,
            endsAfterDay,
        };
        if (height > 0) {
            previousDayEvents.push(dayEvent);
        }
        return dayEvent;
    })
        .filter((dayEvent) => dayEvent.height > 0);
    const width = Math.max(...dayViewEvents.map((event) => event.left + event.width));
    const allDayEvents = getEventsInPeriod({
        events: events.filter((event) => event.allDay),
        periodStart: DateUtil.startOfDay(startOfView),
        periodEnd: DateUtil.endOfDay(endOfView),
    });
    return {
        events: dayViewEvents,
        width,
        allDayEvents,
    };
}
export function getDayViewHourGrid({ viewDate, hourSegments, dayStart, dayEnd, }) {
    const hours = [];
    const startOfView = DateUtil.setMinutes(DateUtil.setHours(DateUtil.startOfDay(viewDate), dayStart.hour), dayStart.minute);
    const endOfView = DateUtil.setMinutes(DateUtil.setHours(DateUtil.startOfMinute(DateUtil.endOfDay(viewDate)), dayEnd.hour), dayEnd.minute);
    const segmentDuration = MINUTES_IN_HOUR / hourSegments;
    const startOfViewDay = DateUtil.startOfDay(viewDate);
    for (let i = 0; i < HOURS_IN_DAY; i++) {
        const segments = [];
        for (let j = 0; j < hourSegments; j++) {
            const date = addMinutes(addHours(startOfViewDay, i), j * segmentDuration);
            if (date >= startOfView && date < endOfView) {
                segments.push({
                    date,
                    isStart: j === 0,
                });
            }
        }
        if (segments.length > 0) {
            hours.push({ segments });
        }
    }
    return hours;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsZW5kYXItdXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9lbGVtZW50cy91dGlscy9jYWxlbmRhci11dGlscy9jYWxlbmRhci11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDN0UsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUVuQyxNQUFNLG1CQUFtQixHQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzFDLE1BQU0sWUFBWSxHQUFXLENBQUMsQ0FBQztBQUMvQixNQUFNLFlBQVksR0FBVyxFQUFFLENBQUM7QUFDaEMsTUFBTSxlQUFlLEdBQVcsRUFBRSxDQUFDO0FBRW5DLE1BQU0sQ0FBTixJQUFZLHFCQUlYO0FBSkQsV0FBWSxxQkFBcUI7SUFDL0IsbUVBQUssQ0FBQTtJQUNMLHlFQUFRLENBQUE7SUFDUix5RUFBUSxDQUFBO0FBQ1YsQ0FBQyxFQUpXLHFCQUFxQixLQUFyQixxQkFBcUIsUUFJaEM7QUFnSUQsU0FBUyxlQUFlLENBQUMsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBeUQ7SUFDM0csSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtRQUN2QixPQUFPLENBQUMsQ0FBQztLQUNWO0lBQ0QsSUFBSSxHQUFHLEdBQVcsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ3JDLElBQUksTUFBTSxHQUFXLENBQUMsQ0FBQztJQUN2QixLQUFLLElBQUksQ0FBQyxHQUFXLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ3JDLElBQUksR0FBRyxLQUFLLFlBQVksRUFBRTtZQUN4QixHQUFHLEdBQUcsQ0FBQyxDQUFDO1NBQ1Q7UUFDRCxJQUFJ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QUNqQixDQUFDLENBQUM7YUFDSjtTQUNGO1FBQ0QsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN2QixLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztTQUMxQjtLQUNGO0lBRUQsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYWRkSG91cnMsIGFkZE1pbnV0ZXMsIGRpZmZlcmVuY2VJbk1pbnV0ZXMsIGdldERheSB9IGZyb20gJ2RhdGUtZm5zJztcbmltcG9ydCB7IERhdGVVdGlsIH0gZnJvbSAnLi4vZGF0ZSc7XG5cbmNvbnN0IFdFRUtFTkRfREFZX05VTUJFUlM6IERheVtdID0gWzAsIDZdO1xuY29uc3QgREFZU19JTl9XRUVLOiBudW1iZXIgPSA3O1xuY29uc3QgSE9VUlNfSU5fREFZOiBudW1iZXIgPSAyNDtcbmNvbnN0IE1JTlVURVNfSU5fSE9VUjogbnVtYmVyID0gNjA7XG5cbmV4cG9ydCBlbnVtIENhbGVuZGFyRXZlbnRSZXNwb25zZSB7XG4gIE1heWJlLFxuICBBY2NlcHRlZCxcbiAgUmVqZWN0ZWQsXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FsZW5kYXJFdmVudFRpbWVzQ2hhbmdlZEV2ZW50IHtcbiAgZXZlbnQ6IENhbGVuZGFyRXZlbnQ7XG4gIG5ld1N0YXJ0OiBEYXRlO1xuICBuZXdFbmQ/OiBEYXRlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFdlZWtEYXkge1xuICBkYXRlOiBEYXRlO1xuICBpc1Bhc3Q6IGJvb2xlYW47XG4gIGlzVG9kYXk6IGJvb2xlYW47XG4gIGlzRnV0dXJlOiBib29sZWFuO1xuICBpc1dlZWtlbmQ6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRDb2xvciB7XG4gIHByaW1hcnk6IHN0cmluZztcbiAgc2Vjb25kYXJ5OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRBY3Rpb24ge1xuICBsYWJlbDogc3RyaW5nO1xuICBjc3NDbGFzcz86IHN0cmluZztcbiAgb25DbGljayh7IGV2ZW50IH06IHsgZXZlbnQ6IENhbGVuZGFyRXZlbnQgfSk6IGFueTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDYWxlbmRhckV2ZW50IHtcbiAgaWQ/OiBudW1iZXI7XG4gIHN0YXJ0OiBEYXRlO1xuICBlbmQ/OiBEYXRlO1xuICB0aXRsZTogc3RyaW5nO1xuICBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgY29sb3I6IEV2ZW50Q29sb3I7XG4gIHR5cGU/OiBzdHJpbmc7XG4gIHJlc3BvbnNlPzogQ2FsZW5kYXJFdmVudFJlc3BvbnNlO1xuICBhY3Rpb25zPzogRXZlbnRBY3Rpb25bXTtcbiAgYWxsRGF5PzogYm9vbGVhbjtcbiAgY3NzQ2xhc3M/OiBzdHJpbmc7XG4gIHJlc2l6YWJsZT86IHtcbiAgICBiZWZvcmVTdGFydD86IGJvb2xlYW47XG4gICAgYWZ0ZXJFbmQ/OiBib29sZWFuO1xuICB9O1xuICBkcmFnZ2FibGU/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFdlZWtWaWV3RXZlbnQge1xuICBldmVudDogQ2FsZW5kYXJFdmVudDtcbiAgb2Zmc2V0OiBudW1iZXI7XG4gIHNwYW46IG51bWJlcjtcbiAgc3RhcnRzQmVmb3JlV2VlazogYm9vbGVhbjtcbiAgZW5kc0FmdGVyV2VlazogYm9vbGVhbjtcbiAgdG9wPzogbnVtYmVyO1xuICBoZWlnaHQ/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgV2Vla1ZpZXdFdmVudFJvdyB7XG4gIHJvdzogV2Vla1ZpZXdFdmVudFtdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1vbnRoVmlld0RheSBleHRlbmRzIFdlZWtEYXkge1xuICBpbk1vbnRoOiBib29sZWFuO1xuICBldmVudHM6IENhbGVuZGFyRXZlbnRbXTtcbiAgYmFja2dyb3VuZENvbG9yPzogc3RyaW5nO1xuICBjc3NDbGFzcz86IHN0cmluZztcbiAgYmFkZ2VUb3RhbDogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1vbnRoVmlldyB7XG4gIHJvd09mZnNldHM6IG51bWJlcltdO1xuICBkYXlzOiBNb250aFZpZXdEYXlbXTtcbiAgdG90YWxEYXlzVmlzaWJsZUluV2VlazogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERheVZpZXdFdmVudCB7XG4gIGV2ZW50OiBDYWxlbmRhckV2ZW50O1xuICBoZWlnaHQ6IG51bWJlcjtcbiAgd2lkdGg6IG51bWJlcjtcbiAgdG9wOiBudW1iZXI7XG4gIGxlZnQ6IG51bWJlcjtcbiAgc3RhcnRzQmVmb3JlRGF5OiBib29sZWFuO1xuICBlbmRzQWZ0ZXJEYXk6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGF5VmlldyB7XG4gIGV2ZW50czogRGF5Vmlld0V2ZW50W107XG4gIHdpZHRoOiBudW1iZXI7XG4gIGFsbERheUV2ZW50czogQ2FsZW5kYXJFdmVudFtdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERheVZpZXdIb3VyU2VnbWVudCB7XG4gIGlzU3RhcnQ6IGJvb2xlYW47XG4gIGRhdGU6IERhdGU7XG4gIGNzc0NsYXNzPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERheVZpZXdIb3VyIHtcbiAgc2VnbWVudHM6IERheVZpZXdIb3VyU2VnbWVudFtdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElzRXZlbnRJblBlcmlvZEFyZ3Mge1xuICBldmVudDogQ2FsZW5kYXJFdmVudDtcbiAgcGVyaW9kU3RhcnQ6IERhdGU7XG4gIHBlcmlvZEVuZDogRGF0ZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHZXRFdmVudHNJblBlcmlvZEFyZ3Mge1xuICBldmVudHM6IENhbGVuZGFyRXZlbnRbXTtcbiAgcGVyaW9kU3RhcnQ6IERhdGU7XG4gIHBlcmlvZEVuZDogRGF0ZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHZXREYXlWaWV3QXJncyB7XG4gIGV2ZW50cz86IENhbGVuZGFyRXZlbnRbXTtcbiAgdmlld0RhdGU6IERhdGU7XG4gIGhvdXJTZWdtZW50czogbnVtYmVyO1xuICBkYXlTdGFydDoge1xuICAgIGhvdXI6IG51bWJlcjtcbiAgICBtaW51dGU6IG51bWJlcjtcbiAgfTtcbiAgZGF5RW5kOiB7XG4gICAgaG91cjogbnVtYmVyO1xuICAgIG1pbnV0ZTogbnVtYmVyO1xuICB9O1xuICBldmVudFdpZHRoOiBudW1iZXI7XG4gIHNlZ21lbnRIZWlnaHQ6IG51bWJlcjtcbn1cblxuZnVuY3Rpb24gZ2V0RXhjbHVkZWREYXlzKHsgc3RhcnREYXRlLCBkYXlzLCBleGNsdWRlZCB9OiB7IHN0YXJ0RGF0ZTogRGF0ZTsgZGF5czogbnVtYmVyOyBleGNsdWRlZDogbnVtYmVyW10gfSk6IG51bWJlciB7XG4gIGlmIChleGNsdWRlZC5sZW5ndGggPCAxKSB7XG4gICAgcmV0dXJuIDA7XG4gIH1cbiAgbGV0IGRheTogbnVtYmVyID0gc3RhcnREYXRlLmdldERheSgpO1xuICBsZXQgcmVkdWNlOiBudW1iZXIgPSAwO1xuICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgZGF5czsgaSsrKSB7XG4gICAgaWYgKGRheSA9PT0gREFZU19JTl9XRUVLKSB7XG4gICAgICBkYXkgPSAwO1xuICAgIH1cbiAgICBpZiAoZXhjbHVkZWQuc29tZSgoZSkgPT4gZSA9PT0gZGF5KSkge1xuICAgICAgcmVkdWNlKys7XG4gICAgfVxuICAgIGRheSsrO1xuICB9XG4gIHJldHVybiByZWR1Y2U7XG59XG5cbmZ1bmN0aW9uIGdldFdlZWtWaWV3RXZlbnRTcGFuKHtcbiAgZXZlbnQsXG4gIG9mZnNldCxcbiAgc3RhcnRPZldlZWssXG4gIGV4Y2x1ZGVkLFxufToge1xuICBldmVudDogQ2FsZW5kYXJFdmVudDtcbiAgb2Zmc2V0OiBudW1iZXI7XG4gIHN0YXJ0T2ZXZWVrOiBEYXRlO1xuICBleGNsdWRlZDogbnVtYmVyW107XG59KTogbnVtYmVyIHtcbiAgY29uc3QgYmVnaW46IERhdGUgPSBldmVudC5zdGFydCA8IHN0YXJ0T2ZXZWVrID8gc3RhcnRPZldlZWsgOiBldmVudC5zdGFydDtcbiAgbGV0IHNwYW46IG51bWJlciA9IDE7XG4gIGlmIChldmVudC5lbmQpIHtcbiAgICBzcGFuID0gRGF0ZVV0aWwuZGlmZmVyZW5jZUluRGF5cyhhZGRNaW51dGVzKERhdGVVdGlsLmVuZE9mRGF5KGV2ZW50LmVuZCksIDEpLCBEYXRlVXRpbC5zdGFydE9mRGF5KGJlZ2luKSk7XG4gIH1cbiAgY29uc3QgdG90YWxMZW5ndGg6IG51bWJlciA9IG9mZnNldCArIHNwYW47XG4gIGlmICh0b3RhbExlbmd0aCA+IERBWVNfSU5fV0VFSykge1xuICAgIHNwYW4gPSBEQVlTX0lOX1dFRUsgLSBvZmZzZXQ7XG4gIH1cbiAgcmV0dXJuIHNwYW4gLSBnZXRFeGNsdWRlZERheXMoeyBzdGFydERhdGU6IGJlZ2luLCBkYXlzOiBzcGFuLCBleGNsdWRlZCB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFdlZWtWaWV3RXZlbnRPZmZzZXQoe1xuICBldmVudCxcbiAgc3RhcnRPZldlZWssXG4gIGV4Y2x1ZGVkID0gW10sXG59OiB7XG4gIGV2ZW50OiBDYWxlbmRhckV2ZW50O1xuICBzdGFydE9mV2VlazogRGF0ZTtcbiAgZXhjbHVkZWQ/OiBudW1iZXJbXTtcbn0pOiBudW1iZXIge1xuICBpZiAoZXZlbnQuc3RhcnQgPCBzdGFydE9mV2Vlaykge1xuICAgIHJldHVybiAwO1xuICB9XG4gIGNvbnN0IGRpc3RhbmNlOiBudW1iZXIgPSBEYXRlVXRpbC5kaWZmZXJlbmNlSW5EYXlzKGV2ZW50LnN0YXJ0LCBzdGFydE9mV2Vlayk7XG4gIHJldHVybiBkaXN0YW5jZSAtIGdldEV4Y2x1ZGVkRGF5cyh7IHN0YXJ0RGF0ZTogc3RhcnRPZldlZWssIGRheXM6IGRpc3RhbmNlLCBleGNsdWRlZCB9KTtcbn1cblxuZnVuY3Rpb24gaXNFdmVudElzUGVyaW9kKHsgZXZlbnQsIHBlcmlvZFN0YXJ0LCBwZXJpb2RFbmQgfTogSXNFdmVudEluUGVyaW9kQXJncyk6IGJvb2xlYW4ge1xuICBjb25zdCBldmVudFN0YXJ0OiBEYXRlID0gZXZlbnQuc3RhcnQ7XG4gIGNvbnN0IGV2ZW50RW5kOiBEYXRlID0gZXZlbnQuZW5kIHx8IGV2ZW50LnN0YXJ0O1xuXG4gIGlmIChldmVudFN0YXJ0ID4gcGVyaW9kU3RhcnQgJiYgZXZlbnRTdGFydCA8IHBlcmlvZEVuZCkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgaWYgKGV2ZW50RW5kID4gcGVyaW9kU3RhcnQgJiYgZXZlbnRFbmQgPCBwZXJpb2RFbmQpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGlmIChldmVudFN0YXJ0IDwgcGVyaW9kU3RhcnQgJiYgZXZlbnRFbmQgPiBwZXJpb2RFbmQpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGlmIChEYXRlVXRpbC5pc1NhbWVTZWNvbmQoZXZlbnRTdGFydCwgcGVyaW9kU3RhcnQpIHx8IERhdGVVdGlsLmlzU2FtZVNlY29uZChldmVudFN0YXJ0LCBwZXJpb2RFbmQpKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBpZiAoRGF0ZVV0aWwuaXNTYW1lU2Vjb25kKGV2ZW50RW5kLCBwZXJpb2RTdGFydCkgfHwgRGF0ZVV0aWwuaXNTYW1lU2Vjb25kKGV2ZW50RW5kLCBwZXJpb2RFbmQpKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICByZXR1cm4gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIGdldEV2ZW50c0luUGVyaW9kKHsgZXZlbnRzLCBwZXJpb2RTdGFydCwgcGVyaW9kRW5kIH06IEdldEV2ZW50c0luUGVyaW9kQXJncyk6IENhbGVuZGFyRXZlbnRbXSB7XG4gIHJldHVybiBldmVudHMuZmlsdGVyKChldmVudDogQ2FsZW5kYXJFdmVudCkgPT4gaXNFdmVudElzUGVyaW9kKHsgZXZlbnQsIHBlcmlvZFN0YXJ0LCBwZXJpb2RFbmQgfSkpO1xufVxuXG5mdW5jdGlvbiBnZXRFdmVudHNJblRpbWVSYW5nZShldmVudHM6IENhbGVuZGFyRXZlbnRbXSwgZGF5U3RhcnQ6IGFueSwgZGF5RW5kOiBhbnkpIHtcbiAgcmV0dXJuIGV2ZW50cy5maWx0ZXIoKGV2ZW50KSA9PiB7XG4gICAgY29uc3QgZXZlbnRTdGFydDogRGF0ZSA9IGV2ZW50LnN0YXJ0O1xuICAgIGNvbnN0IGV2ZW50RW5kOiBEYXRlID0gZXZlbnQuZW5kIHx8IGV2ZW50U3RhcnQ7XG5cbiAgICBjb25zdCBzdGFydE9mVmlldzogRGF0ZSA9IERhdGVVdGlsLnNldE1pbnV0ZXMoRGF0ZVV0aWwuc2V0SG91cnMoRGF0ZVV0aWwuc3RhcnRPZkRheShldmVudFN0YXJ0KSwgZGF5U3RhcnQuaG91ciksIGRheVN0YXJ0Lm1pbnV0ZSk7XG4gICAgY29uc3QgZW5kT2ZWaWV3OiBEYXRlID0gRGF0ZVV0aWwuc2V0TWludXRlcyhEYXRlVXRpbC5zZXRIb3VycyhEYXRlVXRpbC5zdGFydE9mTWludXRlKGV2ZW50U3RhcnQpLCBkYXlFbmQuaG91ciksIGRheUVuZC5taW51dGUpO1xuXG4gICAgcmV0dXJuIERhdGVVdGlsLmlzQWZ0ZXIoZXZlbnRFbmQsIHN0YXJ0T2ZWaWV3KSAmJiBEYXRlVXRpbC5pc0JlZm9yZShldmVudFN0YXJ0LCBlbmRPZlZpZXcpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0V2Vla0RheSh7IGRhdGUgfTogeyBkYXRlOiBEYXRlIH0pOiBXZWVrRGF5IHtcbiAgY29uc3QgdG9kYXk6IERhdGUgPSBEYXRlVXRpbC5zdGFydE9mRGF5KG5ldyBEYXRlKCkpO1xuICByZXR1cm4ge1xuICAgIGRhdGUsXG4gICAgaXNQYXN0OiBkYXRlIDwgdG9kYXksXG4gICAgaXNUb2RheTogRGF0ZVV0aWwuaXNTYW1lRGF5KGRhdGUsIHRvZGF5KSxcbiAgICBpc0Z1dHVyZTogZGF0ZSA+IHRvZGF5LFxuICAgIGlzV2Vla2VuZDogV0VFS0VORF9EQVlfTlVNQkVSUy5pbmRleE9mKGdldERheShkYXRlKSkgPiAtMSxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFdlZWtWaWV3SGVhZGVyKHtcbiAgdmlld0RhdGUsXG4gIHdlZWtTdGFydHNPbixcbiAgZXhjbHVkZWQgPSBbXSxcbn06IHtcbiAgdmlld0RhdGU6IERhdGU7XG4gIHdlZWtTdGFydHNPbjogRGF5O1xuICBleGNsdWRlZD86IG51bWJlcltdO1xufSk6IFdlZWtEYXlbXSB7XG4gIGNvbnN0IHN0YXJ0OiBEYXRlID0gRGF0ZVV0aWwuc3RhcnRPZldlZWsodmlld0RhdGUsIHsgd2Vla1N0YXJ0c09uIH0pO1xuICBjb25zdCBkYXlzOiBXZWVrRGF5W10gPSBbXTtcbiAgZm9yIChsZXQgaTogbnVtYmVyID0gMDsgaSA8IERBWVNfSU5fV0VFSzsgaSsrKSB7XG4gICAgY29uc3QgZGF0ZTogRGF0ZSA9IERhdGVVdGlsLmFkZERheXMoc3RhcnQsIGkpO1xuICAgIGlmICghZXhjbHVkZWQuc29tZSgoZSkgPT4gZGF0ZS5nZXREYXkoKSA9PT0gZSkpIHtcbiAgICAgIGRheXMucHVzaChnZXRXZWVrRGF5KHsgZGF0ZSB9KSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGRheXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRXZWVrVmlldyh7XG4gIGV2ZW50cyA9IFtdLFxuICB2aWV3RGF0ZSxcbiAgd2Vla1N0YXJ0c09uLFxuICBleGNsdWRlZCA9IFtdLFxuICBob3VyU2VnbWVudHMsXG4gIHNlZ21lbnRIZWlnaHQsXG4gIGRheVN0YXJ0LFxuICBkYXlFbmQsXG59OiB7XG4gIGV2ZW50cz86IENhbGVuZGFyRXZlbnRbXTtcbiAgdmlld0RhdGU6IERhdGU7XG4gIHdlZWtTdGFydHNPbjogRGF5O1xuICBleGNsdWRlZD86IG51bWJlcltdO1xuICBob3VyU2VnbWVudHM6IG51bWJlcjtcbiAgc2VnbWVudEhlaWdodDogbnVtYmVyO1xuICBkYXlTdGFydDogYW55O1xuICBkYXlFbmQ6IGFueTtcbn0pOiBXZWVrVmlld0V2ZW50Um93W10ge1xuICBpZiAoIWV2ZW50cykge1xuICAgIGV2ZW50cyA9IFtdO1xuICB9XG5cbiAgY29uc3Qgc3RhcnRPZlZpZXdXZWVrOiBEYXRlID0gRGF0ZVV0aWwuc3RhcnRPZldlZWsodmlld0RhdGUsIHsgd2Vla1N0YXJ0c09uIH0pO1xuICBjb25zdCBlbmRPZlZpZXdXZWVrOiBEYXRlID0gRGF0ZVV0aWwuZW5kT2ZXZWVrKHZpZXdEYXRlLCB7IHdlZWtTdGFydHNPbiB9KTtcbiAgY29uc3QgbWF4UmFuZ2U6IG51bWJlciA9IERBWVNfSU5fV0VFSyAtIGV4Y2x1ZGVkLmxlbmd0aDtcblxuICBjb25zdCBldmVudHNNYXBwZWQ6IFdlZWtWaWV3RXZlbnRbXSA9IGdldEV2ZW50c0luVGltZVJhbmdlKFxuICAgIGdldEV2ZW50c0luUGVyaW9kKHsgZXZlbnRzLCBwZXJpb2RTdGFydDogc3RhcnRPZlZpZXdXZWVrLCBwZXJpb2RFbmQ6IGVuZE9mVmlld1dlZWsgfSksXG4gICAgZGF5U3RhcnQsXG4gICAgZGF5RW5kLFxuICApXG4gICAgLm1hcCgoZXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IG9mZnNldDogbnVtYmVyID0gZ2V0V2Vla1ZpZXdFdmVudE9mZnNldCh7IGV2ZW50LCBzdGFydE9mV2Vlazogc3RhcnRPZlZpZXdXZWVrLCBleGNsdWRlZCB9KTtcbiAgICAgIGNvbnN0IHNwYW46IG51bWJlciA9IDE7IC8vIGdldFdlZWtWaWV3RXZlbnRTcGFuKHsgZXZlbnQsIG9mZnNldCwgc3RhcnRPZldlZWs6IHN0YXJ0T2ZWaWV3V2VlaywgZXhjbHVkZWQgfSk7XG4gICAgICByZXR1cm4geyBldmVudCwgb2Zmc2V0LCBzcGFuIH07XG4gICAgfSlcbiAgICAuZmlsdGVyKChlKSA9PiBlLm9mZnNldCA8IG1heFJhbmdlKVxuICAgIC5maWx0ZXIoKGUpID0+IGUuc3BhbiA+IDApXG4gICAgLm1hcCgoZW50cnkpID0+ICh7XG4gICAgICBldmVudDogZW50cnkuZXZlbnQsXG4gICAgICBvZmZzZXQ6IGVudHJ5Lm9mZnNldCxcbiAgICAgIHNwYW46IGVudHJ5LnNwYW4sXG4gICAgICBzdGFydHNCZWZvcmVXZWVrOiBlbnRyeS5ldmVudC5zdGFydCA8IHN0YXJ0T2ZWaWV3V2VlayxcbiAgICAgIGVuZHNBZnRlcldlZWs6IChlbnRyeS5ldmVudC5lbmQgfHwgZW50cnkuZXZlbnQuc3RhcnQpID4gZW5kT2ZWaWV3V2VlayxcbiAgICAgIHRvcDogMCxcbiAgICB9KSlcbiAgICAuc29ydCgoaXRlbUEsIGl0ZW1CKTogbnVtYmVyID0+IHtcbiAgICAgIGNvbnN0IHN0YXJ0U2Vjb25kc0RpZmY6IG51bWJlciA9IERhdGVVdGlsLmRpZmZlcmVuY2VJblNlY29uZHMoaXRlbUEuZXZlbnQuc3RhcnQsIGl0ZW1CLmV2ZW50LnN0YXJ0KTtcbiAgICAgIGlmIChzdGFydFNlY29uZHNEaWZmID09PSAwKSB7XG4gICAgICAgIHJldHVybiBEYXRlVXRpbC5kaWZmZXJlbmNlSW5TZWNvbmRzKGl0ZW1CLmV2ZW50LmVuZCB8fCBpdGVtQi5ldmVudC5zdGFydCwgaXRlbUEuZXZlbnQuZW5kIHx8IGl0ZW1BLmV2ZW50LnN0YXJ0KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBzdGFydFNlY29uZHNEaWZmO1xuICAgIH0pXG4gICAgLm1hcCgoZW50cnk6IFdlZWtWaWV3RXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IHN0YXJ0T2ZWaWV3OiBEYXRlID0gRGF0ZVV0aWwuc2V0TWludXRlcyhEYXRlVXRpbC5zZXRIb3VycyhEYXRlVXRpbC5zdGFydE9mRGF5KGVudHJ5LmV2ZW50LnN0YXJ0KSwgZGF5U3RhcnQuaG91ciksIGRheVN0YXJ0Lm1pbnV0ZSk7XG4gICAgICBjb25zdCBlbmRPZlZpZXc6IERhdGUgPSBEYXRlVXRpbC5zZXRNaW51dGVzKFxuICAgICAgICBEYXRlVXRpbC5zZXRIb3VycyhEYXRlVXRpbC5zdGFydE9mTWludXRlKERhdGVVdGlsLmVuZE9mRGF5KGVudHJ5LmV2ZW50LnN0YXJ0KSksIGRheUVuZC5ob3VyKSxcbiAgICAgICAgZGF5RW5kLm1pbnV0ZSxcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGV2ZW50U3RhcnQ6IERhdGUgPSBlbnRyeS5ldmVudC5zdGFydDtcbiAgICAgIGNvbnN0IGV2ZW50RW5kOiBEYXRlID0gZW50cnkuZXZlbnQuZW5kIHx8IGV2ZW50U3RhcnQ7XG5cbiAgICAgIGNvbnN0IGhvdXJIZWlnaHRNb2RpZmllcjogbnVtYmVyID0gKGhvdXJTZWdtZW50cyAqIHNlZ21lbnRIZWlnaHQpIC8gTUlOVVRFU19JTl9IT1VSO1xuXG4gICAgICBpZiAoZXZlbnRTdGFydCA+IHN0YXJ0T2ZWaWV3KSB7XG4gICAgICAgIGVudHJ5LnRvcCArPSBkaWZmZXJlbmNlSW5NaW51dGVzKGV2ZW50U3RhcnQsIHN0YXJ0T2ZWaWV3KTtcbiAgICAgIH1cblxuICAgICAgZW50cnkudG9wICo9IGhvdXJIZWlnaHRNb2RpZmllcjtcblxuICAgICAgY29uc3Qgc3RhcnRzQmVmb3JlRGF5OiBib29sZWFuID0gZXZlbnRTdGFydCA8IHN0YXJ0T2ZWaWV3O1xuICAgICAgY29uc3QgZW5kc0FmdGVyRGF5OiBib29sZWFuID0gZXZlbnRFbmQgPiBlbmRPZlZpZXc7XG5cbiAgICAgIGNvbnN0IHN0YXJ0RGF0ZTogRGF0ZSA9IHN0YXJ0c0JlZm9yZURheSA/IHN0YXJ0T2ZWaWV3IDogZXZlbnRTdGFydDtcbiAgICAgIGNvbnN0IGVuZERhdGU6IERhdGUgPSBlbmRzQWZ0ZXJEYXkgPyBlbmRPZlZpZXcgOiBldmVudEVuZDtcblxuICAgICAgbGV0IGhlaWdodDogbnVtYmVyID0gZGlmZmVyZW5jZUluTWludXRlcyhlbmREYXRlLCBzdGFydERhdGUpO1xuXG4gICAgICBpZiAoIWVudHJ5LmV2ZW50LmVuZCkge1xuICAgICAgICBoZWlnaHQgPSBzZWdtZW50SGVpZ2h0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaGVpZ2h0ICo9IGhvdXJIZWlnaHRNb2RpZmllcjtcbiAgICAgIH1cblxuICAgICAgZW50cnkuaGVpZ2h0ID0gaGVpZ2h0O1xuXG4gICAgICByZXR1cm4gZW50cnk7XG4gICAgfSk7XG5cbiAgY29uc3QgZXZlbnRSb3dzOiBXZWVrVmlld0V2ZW50Um93W10gPSBbXTtcbiAgY29uc3QgYWxsb2NhdGVkRXZlbnRzOiBXZWVrVmlld0V2ZW50W10gPSBbXTtcblxuICBldmVudHNNYXBwZWQuZm9yRWFjaCgoZXZlbnQ6IFdlZWtWaWV3RXZlbnQsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICBpZiAoYWxsb2NhdGVkRXZlbnRzLmluZGV4T2YoZXZlbnQpID09PSAtMSkge1xuICAgICAgYWxsb2NhdGVkRXZlbnRzLnB1c2goZXZlbnQpO1xuXG4gICAgICBjb25zdCBvdGhlclJvd0V2ZW50czogV2Vla1ZpZXdFdmVudFtdID0gZXZlbnRzTWFwcGVkLnNsaWNlKGluZGV4ICsgMSkuZmlsdGVyKChuZXh0RXZlbnQpID0+IHtcbiAgICAgICAgcmV0dXJuIG5leHRFdmVudC50b3AgPT09IGV2ZW50LnRvcCAmJiBuZXh0RXZlbnQub2Zmc2V0ID09PSBldmVudC5vZmZzZXQ7XG4gICAgICB9KTtcblxuICAgICAgaWYgKG90aGVyUm93RXZlbnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgdG90YWxFdmVudHNGb3JSb3cgPSBvdGhlclJvd0V2ZW50cy5sZW5ndGggKyAxO1xuXG4gICAgICAgIGV2ZW50LnNwYW4gPSAxIC8gdG90YWxFdmVudHNGb3JSb3c7XG5cbiAgICAgICAgbGV0IG5leHRPZmZzZXQgPSBldmVudC5zcGFuICsgZXZlbnQub2Zmc2V0O1xuXG4gICAgICAgIG90aGVyUm93RXZlbnRzLmZvckVhY2goKG5leHRFdmVudDogV2Vla1ZpZXdFdmVudCkgPT4ge1xuICAgICAgICAgIG5leHRFdmVudC5vZmZzZXQgPSBuZXh0T2Zmc2V0O1xuICAgICAgICAgIG5leHRFdmVudC5zcGFuID0gZXZlbnQuc3BhbjtcbiAgICAgICAgICBuZXh0T2Zmc2V0ID0gbmV4dEV2ZW50LnNwYW4gKyBuZXh0RXZlbnQub2Zmc2V0O1xuICAgICAgICB9KTtcblxuICAgICAgICBhbGxvY2F0ZWRFdmVudHMucHVzaCguLi5vdGhlclJvd0V2ZW50cyk7XG4gICAgICB9XG5cbiAgICAgIGV2ZW50Um93cy5wdXNoKHtcbiAgICAgICAgcm93OiBbZXZlbnQsIC4uLm90aGVyUm93RXZlbnRzXSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIGV2ZW50Um93cztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE1vbnRoVmlldyh7XG4gIGV2ZW50cyA9IFtdLFxuICB2aWV3RGF0ZSxcbiAgd2Vla1N0YXJ0c09uLFxuICBleGNsdWRlZCA9IFtdLFxufToge1xuICBldmVudHM/OiBDYWxlbmRhckV2ZW50W107XG4gIHZpZXdEYXRlOiBEYXRlO1xuICB3ZWVrU3RhcnRzT246IERheTtcbiAgZXhjbHVkZWQ/OiBudW1iZXJbXTtcbn0pOiBNb250aFZpZXcge1xuICBpZiAoIWV2ZW50cykge1xuICAgIGV2ZW50cyA9IFtdO1xuICB9XG5cbiAgY29uc3Qgc3RhcnQ6IERhdGUgPSBEYXRlVXRpbC5zdGFydE9mV2VlayhEYXRlVXRpbC5zdGFydE9mTW9udGgodmlld0RhdGUpLCB7IHdlZWtTdGFydHNPbiB9KTtcbiAgY29uc3QgZW5kOiBEYXRlID0gRGF0ZVV0aWwuZW5kT2ZXZWVrKERhdGVVdGlsLmVuZE9mTW9udGgodmlld0RhdGUpLCB7IHdlZWtTdGFydHNPbiB9KTtcbiAgY29uc3QgZXZlbnRzSW5Nb250aDogQ2FsZW5kYXJFdmVudFtdID0gZ2V0RXZlbnRzSW5QZXJpb2Qoe1xuICAgIGV2ZW50cyxcbiAgICBwZXJpb2RTdGFydDogc3RhcnQsXG4gICAgcGVyaW9kRW5kOiBlbmQsXG4gIH0pO1xuICBjb25zdCBkYXlzOiBNb250aFZpZXdEYXlbXSA9IFtdO1xuICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgRGF0ZVV0aWwuZGlmZmVyZW5jZUluRGF5cyhlbmQsIHN0YXJ0KSArIDE7IGkrKykge1xuICAgIGNvbnN0IGRhdGU6IERhdGUgPSBEYXRlVXRpbC5hZGREYXlzKHN0YXJ0LCBpKTtcbiAgICBpZiAoIWV4Y2x1ZGVkLnNvbWUoKGUpID0+IGRhdGUuZ2V0RGF5KCkgPT09IGUpKSB7XG4gICAgICBjb25zdCBkYXk6IE1vbnRoVmlld0RheSA9IGdldFdlZWtEYXkoeyBkYXRlIH0pIGFzIE1vbnRoVmlld0RheTtcbiAgICAgIGNvbnN0IGNhbEV2ZW50czogQ2FsZW5kYXJFdmVudFtdID0gZ2V0RXZlbnRzSW5QZXJpb2Qoe1xuICAgICAgICBldmVudHM6IGV2ZW50c0luTW9udGgsXG4gICAgICAgIHBlcmlvZFN0YXJ0OiBEYXRlVXRpbC5zdGFydE9mRGF5KGRhdGUpLFxuICAgICAgICBwZXJpb2RFbmQ6IERhdGVVdGlsLmVuZE9mRGF5KGRhdGUpLFxuICAgICAgfSk7XG4gICAgICBkYXkuaW5Nb250aCA9IERhdGVVdGlsLmlzU2FtZU1vbnRoKGRhdGUsIHZpZXdEYXRlKTtcbiAgICAgIGRheS5ldmVudHMgPSBjYWxFdmVudHM7XG4gICAgICBkYXkuYmFkZ2VUb3RhbCA9IGNhbEV2ZW50cy5sZW5ndGg7XG4gICAgICBkYXlzLnB1c2goZGF5KTtcbiAgICB9XG4gIH1cblxuICBjb25zdCB0b3RhbERheXNWaXNpYmxlSW5XZWVrOiBudW1iZXIgPSBEQVlTX0lOX1dFRUsgLSBleGNsdWRlZC5sZW5ndGg7XG4gIGNvbnN0IHJvd3M6IG51bWJlciA9IE1hdGguZmxvb3IoZGF5cy5sZW5ndGggLyB0b3RhbERheXNWaXNpYmxlSW5XZWVrKTtcbiAgY29uc3Qgcm93T2Zmc2V0czogbnVtYmVyW10gPSBbXTtcbiAgZm9yIChsZXQgaTogbnVtYmVyID0gMDsgaSA8IHJvd3M7IGkrKykge1xuICAgIHJvd09mZnNldHMucHVzaChpICogdG90YWxEYXlzVmlzaWJsZUluV2Vlayk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHJvd09mZnNldHMsXG4gICAgdG90YWxEYXlzVmlzaWJsZUluV2VlayxcbiAgICBkYXlzLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGF5Vmlldyh7IGV2ZW50cyA9IFtdLCB2aWV3RGF0ZSwgaG91clNlZ21lbnRzLCBkYXlTdGFydCwgZGF5RW5kLCBldmVudFdpZHRoLCBzZWdtZW50SGVpZ2h0IH06IEdldERheVZpZXdBcmdzKTogRGF5VmlldyB7XG4gIGlmICghZXZlbnRzKSB7XG4gICAgZXZlbnRzID0gW107XG4gIH1cblxuICBjb25zdCBzdGFydE9mVmlldzogRGF0ZSA9IERhdGVVdGlsLnNldE1pbnV0ZXMoRGF0ZVV0aWwuc2V0SG91cnMoRGF0ZVV0aWwuc3RhcnRPZkRheSh2aWV3RGF0ZSksIGRheVN0YXJ0LmhvdXIpLCBkYXlTdGFydC5taW51dGUpO1xuICBjb25zdCBlbmRPZlZpZXc6IERhdGUgPSBEYXRlVXRpbC5zZXRNaW51dGVzKFxuICAgIERhdGVVdGlsLnNldEhvdXJzKERhdGVVdGlsLnN0YXJ0T2ZNaW51dGUoRGF0ZVV0aWwuZW5kT2ZEYXkodmlld0RhdGUpKSwgZGF5RW5kLmhvdXIpLFxuICAgIGRheUVuZC5taW51dGUsXG4gICk7XG4gIGNvbnN0IHByZXZpb3VzRGF5RXZlbnRzOiBEYXlWaWV3RXZlbnRbXSA9IFtdO1xuXG4gIGNvbnN0IGRheVZpZXdFdmVudHM6IERheVZpZXdFdmVudFtdID0gZ2V0RXZlbnRzSW5UaW1lUmFuZ2UoXG4gICAgZ2V0RXZlbnRzSW5QZXJpb2Qoe1xuICAgICAgZXZlbnRzOiBldmVudHMuZmlsdGVyKChldmVudDogQ2FsZW5kYXJFdmVudCkgPT4gIWV2ZW50LmFsbERheSksXG4gICAgICBwZXJpb2RTdGFydDogc3RhcnRPZlZpZXcsXG4gICAgICBwZXJpb2RFbmQ6IGVuZE9mVmlldyxcbiAgICB9KSxcbiAgICBkYXlTdGFydCxcbiAgICBkYXlFbmQsXG4gIClcbiAgICAuc29ydCgoZXZlbnRBOiBDYWxlbmRhckV2ZW50LCBldmVudEI6IENhbGVuZGFyRXZlbnQpID0+IHtcbiAgICAgIHJldHVybiBldmVudEEuc3RhcnQudmFsdWVPZigpIC0gZXZlbnRCLnN0YXJ0LnZhbHVlT2YoKTtcbiAgICB9KVxuICAgIC5tYXAoKGV2ZW50OiBDYWxlbmRhckV2ZW50KSA9PiB7XG4gICAgICBjb25zdCBldmVudFN0YXJ0OiBEYXRlID0gZXZlbnQuc3RhcnQ7XG4gICAgICBjb25zdCBldmVudEVuZDogRGF0ZSA9IGV2ZW50LmVuZCB8fCBldmVudFN0YXJ0O1xuICAgICAgY29uc3Qgc3RhcnRzQmVmb3JlRGF5OiBib29sZWFuID0gZXZlbnRTdGFydCA8IHN0YXJ0T2ZWaWV3O1xuICAgICAgY29uc3QgZW5kc0FmdGVyRGF5OiBib29sZWFuID0gZXZlbnRFbmQgPiBlbmRPZlZpZXc7XG4gICAgICBjb25zdCBob3VySGVpZ2h0TW9kaWZpZXI6IG51bWJlciA9IChob3VyU2VnbWVudHMgKiBzZWdtZW50SGVpZ2h0KSAvIE1JTlVURVNfSU5fSE9VUjtcblxuICAgICAgbGV0IHRvcDogbnVtYmVyID0gMDtcblxuICAgICAgaWYgKGV2ZW50U3RhcnQgPiBzdGFydE9mVmlldykge1xuICAgICAgICB0b3AgKz0gZGlmZmVyZW5jZUluTWludXRlcyhldmVudFN0YXJ0LCBzdGFydE9mVmlldyk7XG4gICAgICB9XG5cbiAgICAgIHRvcCAqPSBob3VySGVpZ2h0TW9kaWZpZXI7XG5cbiAgICAgIGNvbnN0IHN0YXJ0RGF0ZTogRGF0ZSA9IHN0YXJ0c0JlZm9yZURheSA/IHN0YXJ0T2ZWaWV3IDogZXZlbnRTdGFydDtcbiAgICAgIGNvbnN0IGVuZERhdGU6IERhdGUgPSBlbmRzQWZ0ZXJEYXkgPyBlbmRPZlZpZXcgOiBldmVudEVuZDtcblxuICAgICAgbGV0IGhlaWdodDogbnVtYmVyID0gZGlmZmVyZW5jZUluTWludXRlcyhlbmREYXRlLCBzdGFydERhdGUpO1xuXG4gICAgICBpZiAoIWV2ZW50LmVuZCkge1xuICAgICAgICBoZWlnaHQgPSBzZWdtZW50SGVpZ2h0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaGVpZ2h0ICo9IGhvdXJIZWlnaHRNb2RpZmllcjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgYm90dG9tOiBudW1iZXIgPSB0b3AgKyBoZWlnaHQ7XG5cbiAgICAgIGNvbnN0IG92ZXJsYXBwaW5nUHJldmlvdXNFdmVudHM6IERheVZpZXdFdmVudFtdID0gcHJldmlvdXNEYXlFdmVudHMuZmlsdGVyKChwcmV2aW91c0V2ZW50OiBEYXlWaWV3RXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgcHJldmlvdXNFdmVudFRvcDogbnVtYmVyID0gcHJldmlvdXNFdmVudC50b3A7XG4gICAgICAgIGNvbnN0IHByZXZpb3VzRXZlbnRCb3R0b206IG51bWJlciA9IHByZXZpb3VzRXZlbnQudG9wICsgcHJldmlvdXNFdmVudC5oZWlnaHQ7XG5cbiAgICAgICAgaWYgKHRvcCA8IHByZXZpb3VzRXZlbnRCb3R0b20gJiYgcHJldmlvdXNFdmVudEJvdHRvbSA8IGJvdHRvbSkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKHByZXZpb3VzRXZlbnRUb3AgPD0gdG9wICYmIGJvdHRvbSA8PSBwcmV2aW91c0V2ZW50Qm90dG9tKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9KTtcblxuICAgICAgbGV0IGxlZnQ6IG51bWJlciA9IDA7XG5cbiAgICAgIHdoaWxlIChvdmVybGFwcGluZ1ByZXZpb3VzRXZlbnRzLnNvbWUoKHByZXZpb3VzRXZlbnQpID0+IHByZXZpb3VzRXZlbnQubGVmdCA9PT0gbGVmdCkpIHtcbiAgICAgICAgbGVmdCArPSBldmVudFdpZHRoO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkYXlFdmVudDogRGF5Vmlld0V2ZW50ID0ge1xuICAgICAgICBldmVudCxcbiAgICAgICAgaGVpZ2h0LFxuICAgICAgICB3aWR0aDogZXZlbnRXaWR0aCxcbiAgICAgICAgdG9wLFxuICAgICAgICBsZWZ0LFxuICAgICAgICBzdGFydHNCZWZvcmVEYXksXG4gICAgICAgIGVuZHNBZnRlckRheSxcbiAgICAgIH07XG5cbiAgICAgIGlmIChoZWlnaHQgPiAwKSB7XG4gICAgICAgIHByZXZpb3VzRGF5RXZlbnRzLnB1c2goZGF5RXZlbnQpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZGF5RXZlbnQ7XG4gICAgfSlcbiAgICAuZmlsdGVyKChkYXlFdmVudDogRGF5Vmlld0V2ZW50KSA9PiBkYXlFdmVudC5oZWlnaHQgPiAwKTtcblxuICBjb25zdCB3aWR0aDogbnVtYmVyID0gTWF0aC5tYXgoLi4uZGF5Vmlld0V2ZW50cy5tYXAoKGV2ZW50OiBEYXlWaWV3RXZlbnQpID0+IGV2ZW50LmxlZnQgKyBldmVudC53aWR0aCkpO1xuICBjb25zdCBhbGxEYXlFdmVudHM6IENhbGVuZGFyRXZlbnRbXSA9IGdldEV2ZW50c0luUGVyaW9kKHtcbiAgICBldmVudHM6IGV2ZW50cy5maWx0ZXIoKGV2ZW50OiBDYWxlbmRhckV2ZW50KSA9PiBldmVudC5hbGxEYXkpLFxuICAgIHBlcmlvZFN0YXJ0OiBEYXRlVXRpbC5zdGFydE9mRGF5KHN0YXJ0T2ZWaWV3KSxcbiAgICBwZXJpb2RFbmQ6IERhdGVVdGlsLmVuZE9mRGF5KGVuZE9mVmlldyksXG4gIH0pO1xuXG4gIHJldHVybiB7XG4gICAgZXZlbnRzOiBkYXlWaWV3RXZlbnRzLFxuICAgIHdpZHRoLFxuICAgIGFsbERheUV2ZW50cyxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldERheVZpZXdIb3VyR3JpZCh7XG4gIHZpZXdEYXRlLFxuICBob3VyU2VnbWVudHMsXG4gIGRheVN0YXJ0LFxuICBkYXlFbmQsXG59OiB7XG4gIHZpZXdEYXRlOiBEYXRlO1xuICBob3VyU2VnbWVudHM6IG51bWJlcjtcbiAgZGF5U3RhcnQ6IGFueTtcbiAgZGF5RW5kOiBhbnk7XG59KTogRGF5Vmlld0hvdXJbXSB7XG4gIGNvbnN0IGhvdXJzOiBEYXlWaWV3SG91cltdID0gW107XG5cbiAgY29uc3Qgc3RhcnRPZlZpZXc6IERhdGUgPSBEYXRlVXRpbC5zZXRNaW51dGVzKERhdGVVdGlsLnNldEhvdXJzKERhdGVVdGlsLnN0YXJ0T2ZEYXkodmlld0RhdGUpLCBkYXlTdGFydC5ob3VyKSwgZGF5U3RhcnQubWludXRlKTtcbiAgY29uc3QgZW5kT2ZWaWV3OiBEYXRlID0gRGF0ZVV0aWwuc2V0TWludXRlcyhcbiAgICBEYXRlVXRpbC5zZXRIb3VycyhEYXRlVXRpbC5zdGFydE9mTWludXRlKERhdGVVdGlsLmVuZE9mRGF5KHZpZXdEYXRlKSksIGRheUVuZC5ob3VyKSxcbiAgICBkYXlFbmQubWludXRlLFxuICApO1xuICBjb25zdCBzZWdtZW50RHVyYXRpb246IG51bWJlciA9IE1JTlVURVNfSU5fSE9VUiAvIGhvdXJTZWdtZW50cztcbiAgY29uc3Qgc3RhcnRPZlZpZXdEYXk6IERhdGUgPSBEYXRlVXRpbC5zdGFydE9mRGF5KHZpZXdEYXRlKTtcblxuICBmb3IgKGxldCBpOiBudW1iZXIgPSAwOyBpIDwgSE9VUlNfSU5fREFZOyBpKyspIHtcbiAgICBjb25zdCBzZWdtZW50czogRGF5Vmlld0hvdXJTZWdtZW50W10gPSBbXTtcbiAgICBmb3IgKGxldCBqOiBudW1iZXIgPSAwOyBqIDwgaG91clNlZ21lbnRzOyBqKyspIHtcbiAgICAgIGNvbnN0IGRhdGU6IERhdGUgPSBhZGRNaW51dGVzKGFkZEhvdXJzKHN0YXJ0T2ZWaWV3RGF5LCBpKSwgaiAqIHNlZ21lbnREdXJhdGlvbik7XG4gICAgICBpZiAoZGF0ZSA+PSBzdGFydE9mVmlldyAmJiBkYXRlIDwgZW5kT2ZWaWV3KSB7XG4gICAgICAgIHNlZ21lbnRzLnB1c2goe1xuICAgICAgICAgIGRhdGUsXG4gICAgICAgICAgaXNTdGFydDogaiA9PT0gMCxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChzZWdtZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICBob3Vycy5wdXNoKHsgc2VnbWVudHMgfSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGhvdXJzO1xufVxuIl19