import { Component, forwardRef, Input } from '@angular/core';
import { ControlContainer, FormBuilder, NG_VALUE_ACCESSOR, Validators } from '@angular/forms';
import { NOVO_EXPRESSION_BUILDER } from '../query-builder.tokens';
import * as i0 from "@angular/core";
import * as i1 from "@angular/forms";
import * as i2 from "../../flex/Flex";
import * as i3 from "../../common/typography/caption/caption.component";
import * as i4 from "../../common/typography/text/text.component";
import * as i5 from "../filter-builder/filter-builder.component";
import * as i6 from "../filter-builder/default-condition-defs/date-filter-field.definition";
import * as i7 from "../filter-builder/default-condition-defs/string-filter-field.definition";
import * as i8 from "../filter-builder/default-condition-defs/id-filter-field.definition";
import * as i9 from "../filter-builder/default-condition-defs/number-filter-field.definition";
import * as i10 from "../filter-builder/default-condition-defs/picker-filter-field.definition";
import * as i11 from "../../button/Button";
import * as i12 from "@angular/common";
import * as i13 from "../../common/directives/space.directive";
import * as i14 from "../../common/directives/theme.directive";
export class ExpressionBuilderComponent {
    constructor(controlContainer, formBuilder) {
        this.controlContainer = controlContainer;
        this.formBuilder = formBuilder;
    }
    ngOnInit() {
        this.parentForm = this.controlContainer.control;
    }
    handleAddOrFilter(evt) {
        // console.log('Add Or', evt);
    }
    handleAddAndFilter(evt) {
        // console.log('Add And', evt);
        this.addAndGroup();
    }
    andGroups() {
        return this.parentForm.get(this.controlName);
    }
    newAndGroup() {
        return this.formBuilder.group({
            $or: this.formBuilder.array([this.newOrGroup()]),
        });
    }
    addAndGroup() {
        this.andGroups().push(this.newAndGroup());
        // console.log(this.parentForm.value);
    }
    removeAndGroup(index) {
        this.andGroups().removeAt(index);
    }
    orGroups(index) {
        return this.andGroups().at(index).get('$or');
    }
    newOrGroup() {
        return this.formBuilder.group({
            field: [null, Validators.required],
            operator: [null, Validators.required],
            value: [null, Validators.required],
        });
    }
    addOrGroup(index) {
        this.orGroups(index).push(this.newOrGroup());
    }
    removeOrGroup(index, orIndex) {
        this.orGroups(index).removeAt(orIndex);
        if (!this.orGroups(index).controls.length) {
            this.removeAndGroup(index);
        }
    }
    canAddGroup() {
        // console.log('can Add Group', this.andGroups().controls, this.parentForm.valid);
        if (this.andGroups().controls.length < 1)
            return true;
        const len = this.andGroups().controls.length - 1;
        const last = this.orGroups(len).controls.length - 1;
        // console.log('last value', this.orGroups(len).at(last).value);
        const { field, value } = this.orGroups(len).at(last).value;
        return !!field && !!value;
    }
}
ExpressionBuilderComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.0", ngImport: i0, type: ExpressionBuilderComponent, deps: [{ token: i1.ControlContainer }, { token: i1.FormBuilder }], target: i0.ɵɵFactoryTarget.Component });
ExpressionBuilderComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.3.0", type: ExpressionBuilderComponent, selector: "novo-expression-builder", inputs: { config: "config", controlName: "controlName" }, providers: [
        { provide: NG_VALUE_ACCESSOR, useExisting: forwardRef(() => ExpressionBuilderComponent), multi: true },
        { provide: NOVO_EXPRESSION_BUILDER, useExisting: ExpressionBuilderComponent },
    ], ngImport: i0, template: "<form [formGroup]=\"parentForm\">\n  <novo-stack [formArrayName]=\"controlName\" class=\"expression-builder\">\n    <ng-container *ngFor=\"let andGroup of andGroups().controls; let andIndex = index; let isFirst = first\">\n      <div *ngIf=\"!isFirst\" class=\"and-connector\" aria-hidden=\"false\">\n        <div class=\"and-connector-line\"></div>\n        <novo-caption class=\"and-connector-text\">and</novo-caption>\n      </div>\n      <ng-container [formGroupName]=\"andIndex\">\n        <novo-stack\n          class=\"expression-group\"\n          [class.with-conditions]=\"orGroups(andIndex).controls.length > 1\"\n          [class.with-one-condition]=\"orGroups(andIndex).controls.length == 1\"\n          formArrayName=\"$or\">\n          <ng-container\n            *ngFor=\"\n              let orGroup of orGroups(andIndex).controls;\n              let orIndex = index;\n              let isFirstOr = first;\n              let isLastOr = last\n            \">\n            <novo-flex class=\"expression-block\" [class.or-block]=\"orGroups(andIndex).controls.length > 1 && !isLastOr\">\n              <div *ngIf=\"!isFirstOr\" class=\"or-connector\" aria-hidden=\"false\">\n                <!-- <div class=\"or-connector-line\"></div> -->\n                <novo-text class=\"or-connector-text\" color=\"ocean\" weight=\"bold\" padding=\"sm\" mx=\"lg\">OR</novo-text>\n              </div>\n              <novo-filter-builder [formGroupName]=\"orIndex\" [config]=\"config\">\n                <novo-date-filter-field-def name=\"Timestamp\"></novo-date-filter-field-def>\n                <novo-string-filter-field-def name=\"String\"></novo-string-filter-field-def>\n                <novo-id-filter-field-def name=\"ID\"></novo-id-filter-field-def>\n                <novo-number-filter-field-def name=\"Float\"></novo-number-filter-field-def>\n                <novo-number-filter-field-def name=\"Integer\"></novo-number-filter-field-def>\n                <novo-number-filter-field-def name=\"BigDecimal\"></novo-number-filter-field-def>\n                <novo-picker-filter-field-def name=\"SELECT\"></novo-picker-filter-field-def>\n                <ng-content></ng-content>\n              </novo-filter-builder>\n              <button *ngIf=\"isLastOr\" theme=\"secondary\" size=\"sm\" class=\"and-or-filter-button\"\n                (click)=\"addOrGroup(andIndex)\">Or</button>\n              <novo-button theme=\"icon\" icon=\"delete-o\" (click)=\"removeOrGroup(andIndex, orIndex)\"></novo-button>\n            </novo-flex>\n\n          </ng-container>\n        </novo-stack>\n      </ng-container>\n    </ng-container>\n  </novo-stack>\n  <button class=\"and-or-filter-button\" theme=\"secondary\" size=\"sm\" (click)=\"addAndGroup()\"\n    [disabled]=\"!canAddGroup()\">Add Criteria</button>\n</form>\n<!-- \n  {\n    $and: [{\n      $or: [{\n        entity: 'JobOrder'\n        field: 'categories',\n        operator: 'doesNotContain',\n        value: 'Healthcare'\n      }]\n    }]\n  }\n -->", styles: [":host{position:relative;display:block}:host .expression-builder .expression-block{width:100%;padding-bottom:.4rem}:host .expression-builder .expression-group{width:100%;border:1px solid transparent;border-radius:.4rem}:host .expression-builder .expression-group.with-conditions{padding:.5rem;margin-bottom:.5rem;border-color:#e6e6e6}:host .expression-builder .expression-group.with-one-condition{border-bottom:1px solid #e6e6e6}:host .and-or-filter-button{box-sizing:border-box;background:#fff;border:1px solid #ddd;color:#5691f5;display:inline-block;position:relative;cursor:pointer;margin:.4rem;align-items:center;text-align:center;-webkit-user-select:none;-moz-user-select:none;user-select:none;outline:none;white-space:nowrap;text-transform:uppercase;transition:box-shadow .4s cubic-bezier(.25,.8,.25,1),background-color .4s cubic-bezier(.25,.8,.25,1)}:host .and-connector{background:#fff;padding:0 5px;position:relative;width:100%}:host .and-connector .and-connector-line{height:1px;width:100%}:host .and-connector .and-connector-text{background-color:#fff;background-color:var(--background-alt, #ffffff);margin:-8px 0 0 10px;position:absolute;text-align:center;text-transform:uppercase}\n"], components: [{ type: i2.NovoStackElement, selector: "novo-stack,novo-column", inputs: ["direction", "align"] }, { type: i3.NovoCaption, selector: "novo-caption,[novo-caption]" }, { type: i2.NovoFlexElement, selector: "novo-flex,novo-row", inputs: ["direction", "align", "justify", "wrap", "gap"] }, { type: i4.NovoText, selector: "novo-text,[novo-text]", inputs: ["block"] }, { type: i5.FilterBuilderComponent, selector: "novo-filter-builder", inputs: ["label", "config", "editTypeFn"] }, { type: i6.NovoDefaultDateFilterFieldDef, selector: "novo-date-filter-field-def" }, { type: i7.NovoDefaultStringFilterFieldDef, selector: "novo-string-filter-field-def" }, { type: i8.NovoDefaultIdFilterFieldDef, selector: "novo-id-filter-field-def" }, { type: i9.NovoDefaultNumberFilterFieldDef, selector: "novo-number-filter-field-def" }, { type: i10.NovoDefaultPickerFilterFieldDef, selector: "novo-picker-filter-field-def" }, { type: i11.NovoButtonElement, selector: "novo-button,button[theme]", inputs: ["color", "side", "size", "theme", "loading", "icon", "disabled"] }], directives: [{ type: i1.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { type: i1.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { type: i1.FormGroupDirective, selector: "[formGroup]", inputs: ["formGroup"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { type: i1.FormArrayName, selector: "[formArrayName]", inputs: ["formArrayName"] }, { type: i12.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { type: i12.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i1.FormGroupName, selector: "[formGroupName]", inputs: ["formGroupName"] }, { type: i13.PaddingDirective, selector: "[p],[padding],[paddingTop],[paddingRight],[paddingBottom],[paddingLeft],[paddingX],[paddingY],[pt],[pr],[pb],[pl],[px],[py]", inputs: ["padding", "p", "paddingLeft", "pl", "paddingRight", "pr", "paddingTop", "pt", "paddingBottom", "pb", "paddingX", "px", "paddingY", "py"] }, { type: i13.MarginDirective, selector: "[m],[margin],[marginTop],[marginRight],[marginBottom],[marginLeft],[marginX],[marginY],[mt],[mr],[mb],[ml],[mx],[my]", inputs: ["margin", "m", "marginLeft", "ml", "marginRight", "mr", "marginTop", "mt", "marginBottom", "mb", "marginX", "mx", "marginY", "my"] }, { type: i14.ThemeColorDirective, selector: "[theme]", inputs: ["theme"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.0", ngImport: i0, type: ExpressionBuilderComponent, decorators: [{
            type: Component,
            args: [{ selector: 'novo-expression-builder', providers: [
                        { provide: NG_VALUE_ACCESSOR, useExisting: forwardRef(() => ExpressionBuilderComponent), multi: true },
                        { provide: NOVO_EXPRESSION_BUILDER, useExisting: ExpressionBuilderComponent },
                    ], template: "<form [formGroup]=\"parentForm\">\n  <novo-stack [formArrayName]=\"controlName\" class=\"expression-builder\">\n    <ng-container *ngFor=\"let andGroup of andGroups().controls; let andIndex = index; let isFirst = first\">\n      <div *ngIf=\"!isFirst\" class=\"and-connector\" aria-hidden=\"false\">\n        <div class=\"and-connector-line\"></div>\n        <novo-caption class=\"and-connector-text\">and</novo-caption>\n      </div>\n      <ng-container [formGroupName]=\"andIndex\">\n        <novo-stack\n          class=\"expression-group\"\n          [class.with-conditions]=\"orGroups(andIndex).controls.length > 1\"\n          [class.with-one-condition]=\"orGroups(andIndex).controls.length == 1\"\n          formArrayName=\"$or\">\n          <ng-container\n            *ngFor=\"\n              let orGroup of orGroups(andIndex).controls;\n              let orIndex = index;\n              let isFirstOr = first;\n              let isLastOr = last\n            \">\n            <novo-flex class=\"expression-block\" [class.or-block]=\"orGroups(andIndex).controls.length > 1 && !isLastOr\">\n              <div *ngIf=\"!isFirstOr\" class=\"or-connector\" aria-hidden=\"false\">\n                <!-- <div class=\"or-connector-line\"></div> -->\n                <novo-text class=\"or-connector-text\" color=\"ocean\" weight=\"bold\" padding=\"sm\" mx=\"lg\">OR</novo-text>\n              </div>\n              <novo-filter-builder [formGroupName]=\"orIndex\" [config]=\"config\">\n                <novo-date-filter-field-def name=\"Timestamp\"></novo-date-filter-field-def>\n                <novo-string-filter-field-def name=\"String\"></novo-string-filter-field-def>\n                <novo-id-filter-field-def name=\"ID\"></novo-id-filter-field-def>\n                <novo-number-filter-field-def name=\"Float\"></novo-number-filter-field-def>\n                <novo-number-filter-field-def name=\"Integer\"></novo-number-filter-field-def>\n                <novo-number-filter-field-def name=\"BigDecimal\"></novo-number-filter-field-def>\n                <novo-picker-filter-field-def name=\"SELECT\"></novo-picker-filter-field-def>\n                <ng-content></ng-content>\n              </novo-filter-builder>\n              <button *ngIf=\"isLastOr\" theme=\"secondary\" size=\"sm\" class=\"and-or-filter-button\"\n                (click)=\"addOrGroup(andIndex)\">Or</button>\n              <novo-button theme=\"icon\" icon=\"delete-o\" (click)=\"removeOrGroup(andIndex, orIndex)\"></novo-button>\n            </novo-flex>\n\n          </ng-container>\n        </novo-stack>\n      </ng-container>\n    </ng-container>\n  </novo-stack>\n  <button class=\"and-or-filter-button\" theme=\"secondary\" size=\"sm\" (click)=\"addAndGroup()\"\n    [disabled]=\"!canAddGroup()\">Add Criteria</button>\n</form>\n<!-- \n  {\n    $and: [{\n      $or: [{\n        entity: 'JobOrder'\n        field: 'categories',\n        operator: 'doesNotContain',\n        value: 'Healthcare'\n      }]\n    }]\n  }\n -->", styles: [":host{position:relative;display:block}:host .expression-builder .expression-block{width:100%;padding-bottom:.4rem}:host .expression-builder .expression-group{width:100%;border:1px solid transparent;border-radius:.4rem}:host .expression-builder .expression-group.with-conditions{padding:.5rem;margin-bottom:.5rem;border-color:#e6e6e6}:host .expression-builder .expression-group.with-one-condition{border-bottom:1px solid #e6e6e6}:host .and-or-filter-button{box-sizing:border-box;background:#fff;border:1px solid #ddd;color:#5691f5;display:inline-block;position:relative;cursor:pointer;margin:.4rem;align-items:center;text-align:center;-webkit-user-select:none;-moz-user-select:none;user-select:none;outline:none;white-space:nowrap;text-transform:uppercase;transition:box-shadow .4s cubic-bezier(.25,.8,.25,1),background-color .4s cubic-bezier(.25,.8,.25,1)}:host .and-connector{background:#fff;padding:0 5px;position:relative;width:100%}:host .and-connector .and-connector-line{height:1px;width:100%}:host .and-connector .and-connector-text{background-color:#fff;background-color:var(--background-alt, #ffffff);margin:-8px 0 0 10px;position:absolute;text-align:center;text-transform:uppercase}\n"] }]
        }], ctorParameters: function () { return [{ type: i1.ControlContainer }, { type: i1.FormBuilder }]; }, propDecorators: { config: [{
                type: Input
            }], controlName: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbi1idWlsZGVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25vdm8tZWxlbWVudHMvc3JjL2VsZW1lbnRzL3F1ZXJ5LWJ1aWxkZXIvZXhwcmVzc2lvbi1idWlsZGVyL2V4cHJlc3Npb24tYnVpbGRlci5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9ub3ZvLWVsZW1lbnRzL3NyYy9lbGVtZW50cy9xdWVyeS1idWlsZGVyL2V4cHJlc3Npb24tYnVpbGRlci9leHByZXNzaW9uLWJ1aWxkZXIuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBQ3JFLE9BQU8sRUFBbUIsZ0JBQWdCLEVBQWEsV0FBVyxFQUFhLGlCQUFpQixFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JJLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDOzs7Ozs7Ozs7Ozs7Ozs7O0FBV2xFLE1BQU0sT0FBTywwQkFBMEI7SUFLckMsWUFBb0IsZ0JBQWtDLEVBQVUsV0FBd0I7UUFBcEUscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUFVLGdCQUFXLEdBQVgsV0FBVyxDQUFhO0lBQUcsQ0FBQztJQUU1RixRQUFRO1FBQ04sSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDO0lBQ2xELENBQUM7SUFFRCxpQkFBaUIsQ0FBQyxHQUFRO1FBQ3hCLDhCQUE4QjtJQUNoQyxDQUFDO0lBRUQsa0JBQWtCLENBQUMsR0FBUTtRQUN6QiwrQkFBK0I7UUFDL0IsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxTQUFTO1FBQ1AsT0FBTyxJQUFJ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eEI7d0JBQ1QsRUFBRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsV0FBVyxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsMkJBQTJCLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFO3dCQUN0RyxFQUFFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxXQUFXLDRCQUE0QixFQUFFO3FCQUM5RTtpSUFJUSxNQUFNO3NCQUFkLEtBQUs7Z0JBQ0csV0FBVztzQkFBbkIsS0FBSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgZm9yd2FyZFJlZiwgSW5wdXQsIE9uSW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWJzdHJhY3RDb250cm9sLCBDb250cm9sQ29udGFpbmVyLCBGb3JtQXJyYXksIEZvcm1CdWlsZGVyLCBGb3JtR3JvdXAsIE5HX1ZBTFVFX0FDQ0VTU09SLCBWYWxpZGF0b3JzIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgTk9WT19FWFBSRVNTSU9OX0JVSUxERVIgfSBmcm9tICcuLi9xdWVyeS1idWlsZGVyLnRva2Vucyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25vdm8tZXhwcmVzc2lvbi1idWlsZGVyJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2V4cHJlc3Npb24tYnVpbGRlci5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2V4cHJlc3Npb24tYnVpbGRlci5jb21wb25lbnQuc2NzcyddLFxuICBwcm92aWRlcnM6IFtcbiAgICB7IHByb3ZpZGU6IE5HX1ZBTFVFX0FDQ0VTU09SLCB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBFeHByZXNzaW9uQnVpbGRlckNvbXBvbmVudCksIG11bHRpOiB0cnVlIH0sXG4gICAgeyBwcm92aWRlOiBOT1ZPX0VYUFJFU1NJT05fQlVJTERFUiwgdXNlRXhpc3Rpbmc6IEV4cHJlc3Npb25CdWlsZGVyQ29tcG9uZW50IH0sXG4gIF0sXG59KVxuZXhwb3J0IGNsYXNzIEV4cHJlc3Npb25CdWlsZGVyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgcHVibGljIHBhcmVudEZvcm06IEFic3RyYWN0Q29udHJvbDtcbiAgQElucHV0KCkgY29uZmlnOiBhbnk7XG4gIEBJbnB1dCgpIGNvbnRyb2xOYW1lOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjb250cm9sQ29udGFpbmVyOiBDb250cm9sQ29udGFpbmVyLCBwcml2YXRlIGZvcm1CdWlsZGVyOiBGb3JtQnVpbGRlcikge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnBhcmVudEZvcm0gPSB0aGlzLmNvbnRyb2xDb250YWluZXIuY29udHJvbDtcbiAgfVxuXG4gIGhhbmRsZUFkZE9yRmlsdGVyKGV2dDogYW55KSB7XG4gICAgLy8gY29uc29sZS5sb2coJ0FkZCBPcicsIGV2dCk7XG4gIH1cblxuICBoYW5kbGVBZGRBbmRGaWx0ZXIoZXZ0OiBhbnkpIHtcbiAgICAvLyBjb25zb2xlLmxvZygnQWRkIEFuZCcsIGV2dCk7XG4gICAgdGhpcy5hZGRBbmRHcm91cCgpO1xuICB9XG5cbiAgYW5kR3JvdXBzKCk6IEZvcm1BcnJheSB7XG4gICAgcmV0dXJuIHRoaXMucGFyZW50Rm9ybS5nZXQodGhpcy5jb250cm9sTmFtZSkgYXMgRm9ybUFycmF5O1xuICB9XG5cbiAgbmV3QW5kR3JvdXAoKTogRm9ybUdyb3VwIHtcbiAgICByZXR1cm4gdGhpcy5mb3JtQnVpbGRlci5ncm91cCh7XG4gICAgICAkb3I6IHRoaXMuZm9ybUJ1aWxkZXIuYXJyYXkoW3RoaXMubmV3T3JHcm91cCgpXSksXG4gICAgfSk7XG4gIH1cblxuICBhZGRBbmRHcm91cCgpIHtcbiAgICB0aGlzLmFuZEdyb3VwcygpLnB1c2godGhpcy5uZXdBbmRHcm91cCgpKTtcbiAgICAvLyBjb25zb2xlLmxvZyh0aGlzLnBhcmVudEZvcm0udmFsdWUpO1xuICB9XG5cbiAgcmVtb3ZlQW5kR3JvdXAoaW5kZXg6IG51bWJlcikge1xuICAgIHRoaXMuYW5kR3JvdXBzKCkucmVtb3ZlQXQoaW5kZXgpO1xuICB9XG5cbiAgb3JHcm91cHMoaW5kZXg6IG51bWJlcik6IEZvcm1BcnJheSB7XG4gICAgcmV0dXJuIHRoaXMuYW5kR3JvdXBzKCkuYXQoaW5kZXgpLmdldCgnJG9yJykgYXMgRm9ybUFycmF5O1xuICB9XG5cbiAgbmV3T3JHcm91cCgpOiBGb3JtR3JvdXAge1xuICAgIHJldHVybiB0aGlzLmZvcm1CdWlsZGVyLmdyb3VwKHtcbiAgICAgIGZpZWxkOiBbbnVsbCwgVmFsaWRhdG9ycy5yZXF1aXJlZF0sXG4gICAgICBvcGVyYXRvcjogW251bGwsIFZhbGlkYXRvcnMucmVxdWlyZWRdLFxuICAgICAgdmFsdWU6IFtudWxsLCBWYWxpZGF0b3JzLnJlcXVpcmVkXSxcbiAgICB9KTtcbiAgfVxuXG4gIGFkZE9yR3JvdXAoaW5kZXg6IG51bWJlcikge1xuICAgIHRoaXMub3JHcm91cHMoaW5kZXgpLnB1c2godGhpcy5uZXdPckdyb3VwKCkpO1xuICB9XG5cbiAgcmVtb3ZlT3JHcm91cChpbmRleDogbnVtYmVyLCBvckluZGV4OiBudW1iZXIpIHtcbiAgICB0aGlzLm9yR3JvdXBzKGluZGV4KS5yZW1vdmVBdChvckluZGV4KTtcbiAgICBpZiAoIXRoaXMub3JHcm91cHMoaW5kZXgpLmNvbnRyb2xzLmxlbmd0aCkge1xuICAgICAgdGhpcy5yZW1vdmVBbmRHcm91cChpbmRleCk7XG4gICAgfVxuICB9XG5cbiAgY2FuQWRkR3JvdXAoKSB7XG4gICAgLy8gY29uc29sZS5sb2coJ2NhbiBBZGQgR3JvdXAnLCB0aGlzLmFuZEdyb3VwcygpLmNvbnRyb2xzLCB0aGlzLnBhcmVudEZvcm0udmFsaWQpO1xuICAgIGlmICh0aGlzLmFuZEdyb3VwcygpLmNvbnRyb2xzLmxlbmd0aCA8IDEpIHJldHVybiB0cnVlO1xuICAgIGNvbnN0IGxlbiA9IHRoaXMuYW5kR3JvdXBzKCkuY29udHJvbHMubGVuZ3RoIC0gMTtcbiAgICBjb25zdCBsYXN0ID0gdGhpcy5vckdyb3VwcyhsZW4pLmNvbnRyb2xzLmxlbmd0aCAtIDE7XG4gICAgLy8gY29uc29sZS5sb2coJ2xhc3QgdmFsdWUnLCB0aGlzLm9yR3JvdXBzKGxlbikuYXQobGFzdCkudmFsdWUpO1xuICAgIGNvbnN0IHsgZmllbGQsIHZhbHVlIH0gPSB0aGlzLm9yR3JvdXBzKGxlbikuYXQobGFzdCkudmFsdWU7XG4gICAgcmV0dXJuICEhZmllbGQgJiYgISF2YWx1ZTtcbiAgfVxufVxuIiwiPGZvcm0gW2Zvcm1Hcm91cF09XCJwYXJlbnRGb3JtXCI+XG4gIDxub3ZvLXN0YWNrIFtmb3JtQXJyYXlOYW1lXT1cImNvbnRyb2xOYW1lXCIgY2xhc3M9XCJleHByZXNzaW9uLWJ1aWxkZXJcIj5cbiAgICA8bmctY29udGFpbmVyICpuZ0Zvcj1cImxldCBhbmRHcm91cCBvZiBhbmRHcm91cHMoKS5jb250cm9sczsgbGV0IGFuZEluZGV4ID0gaW5kZXg7IGxldCBpc0ZpcnN0ID0gZmlyc3RcIj5cbiAgICAgIDxkaXYgKm5nSWY9XCIhaXNGaXJzdFwiIGNsYXNzPVwiYW5kLWNvbm5lY3RvclwiIGFyaWEtaGlkZGVuPVwiZmFsc2VcIj5cbiAgICAgICAgPGRpdiBjbGFzcz1cImFuZC1jb25uZWN0b3ItbGluZVwiPjwvZGl2PlxuICAgICAgICA8bm92by1jYXB0aW9uIGNsYXNzPVwiYW5kLWNvbm5lY3Rvci10ZXh0XCI+YW5kPC9ub3ZvLWNhcHRpb24+XG4gICAgICA8L2Rpdj5cbiAgICAgIDxuZy1jb250YWluZXIgW2Zvcm1Hcm91cE5hbWVdPVwiYW5kSW5kZXhcIj5cbiAgICAgICAgPG5vdm8tc3RhY2tcbiAgICAgICAgICBjbGFzcz1cImV4cHJlc3Npb24tZ3JvdXBcIlxuICAgICAgICAgIFtjbGFzcy53aXRoLWNvbmRpdGlvbnNdPVwib3JHcm91cHMoYW5kSW5kZXgpLmNvbnRyb2xzLmxlbmd0aCA+IDFcIlxuICAgICAgICAgIFtjbGFzcy53aXRoLW9uZS1jb25kaXRpb25dPVwib3JHcm91cHMoYW5kSW5kZXgpLmNvbnRyb2xzLmxlbmd0aCA9PSAxXCJcbiAgICAgICAgICBmb3JtQXJyYXlOYW1lPVwiJG9yXCI+XG4gICAgICAgICAgPG5nLWNvbnRhaW5lclxuICAgICAgICAgICAgKm5nRm9yPVwiXG4gICAgICAgICAgICAgIGxldCBvckdyb3VwIG9mIG9yR3JvdXBzKGFuZEluZGV4KS5jb250cm9scztcbiAgICAgICAgICAgICAgbGV0IG9ySW5kZXggPSBpbmRleDtcbiAgICAgICAgICAgICAgbGV0IGlzRmlyc3RPciA9IGZpcnN0O1xuICAgICAgICAgICAgICBsZXQgaXNMYXN0T3IgPSBsYXN0XG4gICAgICAgICAgICBcIj5cbiAgICAgICAgICAgIDxub3ZvLWZsZXggY2xhc3M9XCJleHByZXNzaW9uLWJsb2NrXCIgW2NsYXNzLm9yLWJsb2NrXT1cIm9yR3JvdXBzKGFuZEluZGV4KS5jb250cm9scy5sZW5ndGggPiAxICYmICFpc0xhc3RPclwiPlxuICAgICAgICAgICAgICA8ZGl2ICpuZ0lmPVwiIWlzRmlyc3RPclwiIGNsYXNzPVwib3ItY29ubmVjdG9yXCIgYXJpYS1oaWRkZW49XCJmYWxzZVwiPlxuICAgICAgICAgICAgICAgIDwhLS0gPGRpdiBjbGFzcz1cIm9yLWNvbm5lY3Rvci1saW5lXCI+PC9kaXY+IC0tPlxuICAgICAgICAgICAgICAgIDxub3ZvLXRleHQgY2xhc3M9XCJvci1jb25uZWN0b3ItdGV4dFwiIGNvbG9yPVwib2NlYW5cIiB3ZWlnaHQ9XCJib2xkXCIgcGFkZGluZz1cInNtXCIgbXg9XCJsZ1wiPk9SPC9ub3ZvLXRleHQ+XG4gICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICA8bm92by1maWx0ZXItYnVpbGRlciBbZm9ybUdyb3VwTmFtZV09XCJvckluZGV4XCIgW2NvbmZpZ109XCJjb25maWdcIj5cbiAgICAgICAgICAgICAgICA8bm92by1kYXRlLWZpbHRlci1maWVsZC1kZWYgbmFtZT1cIlRpbWVzdGFtcFwiPjwvbm92by1kYXRlLWZpbHRlci1maWVsZC1kZWY+XG4gICAgICAgICAgICAgICAgPG5vdm8tc3RyaW5nLWZpbHRlci1maWVsZC1kZWYgbmFtZT1cIlN0cmluZ1wiPjwvbm92by1zdHJpbmctZmlsdGVyLWZpZWxkLWRlZj5cbiAgICAgICAgICAgICAgICA8bm92by1pZC1maWx0ZXItZmllbGQtZGVmIG5hbWU9XCJJRFwiPjwvbm92by1pZC1maWx0ZXItZmllbGQtZGVmPlxuICAgICAgICAgICAgICAgIDxub3ZvLW51bWJlci1maWx0ZXItZmllbGQtZGVmIG5hbWU9XCJGbG9hdFwiPjwvbm92by1udW1iZXItZmlsdGVyLWZpZWxkLWRlZj5cbiAgICAgICAgICAgICAgICA8bm92by1udW1iZXItZmlsdGVyLWZpZWxkLWRlZiBuYW1lPVwiSW50ZWdlclwiPjwvbm92by1udW1iZXItZmlsdGVyLWZpZWxkLWRlZj5cbiAgICAgICAgICAgICAgICA8bm92by1udW1iZXItZmlsdGVyLWZpZWxkLWRlZiBuYW1lPVwiQmlnRGVjaW1hbFwiPjwvbm92by1udW1iZXItZmlsdGVyLWZpZWxkLWRlZj5cbiAgICAgICAgICAgICAgICA8bm92by1waWNrZXItZmlsdGVyLWZpZWxkLWRlZiBuYW1lPVwiU0VMRUNUXCI+PC9ub3ZvLXBpY2tlci1maWx0ZXItZmllbGQtZGVmPlxuICAgICAgICAgICAgICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbiAgICAgICAgICAgICAgPC9ub3ZvLWZpbHRlci1idWlsZGVyPlxuICAgICAgICAgICAgICA8YnV0dG9uICpuZ0lmPVwiaXNMYXN0T3JcIiB0aGVtZT1cInNlY29uZGFyeVwiIHNpemU9XCJzbVwiIGNsYXNzPVwiYW5kLW9yLWZpbHRlci1idXR0b25cIlxuICAgICAgICAgICAgICAgIChjbGljayk9XCJhZGRPckdyb3VwKGFuZEluZGV4KVwiPk9yPC9idXR0b24+XG4gICAgICAgICAgICAgIDxub3ZvLWJ1dHRvbiB0aGVtZT1cImljb25cIiBpY29uPVwiZGVsZXRlLW9cIiAoY2xpY2spPVwicmVtb3ZlT3JHcm91cChhbmRJbmRleCwgb3JJbmRleClcIj48L25vdm8tYnV0dG9uPlxuICAgICAgICAgICAgPC9ub3ZvLWZsZXg+XG5cbiAgICAgICAgICA8L25nLWNvbnRhaW5lcj5cbiAgICAgICAgPC9ub3ZvLXN0YWNrPlxuICAgICAgPC9uZy1jb250YWluZXI+XG4gICAgPC9uZy1jb250YWluZXI+XG4gIDwvbm92by1zdGFjaz5cbiAgPGJ1dHRvbiBjbGFzcz1cImFuZC1vci1maWx0ZXItYnV0dG9uXCIgdGhlbWU9XCJzZWNvbmRhcnlcIiBzaXplPVwic21cIiAoY2xpY2spPVwiYWRkQW5kR3JvdXAoKVwiXG4gICAgW2Rpc2FibGVkXT1cIiFjYW5BZGRHcm91cCgpXCI+QWRkIENyaXRlcmlhPC9idXR0b24+XG48L2Zvcm0+XG48IS0tIFxuICB7XG4gICAgJGFuZDogW3tcbiAgICAgICRvcjogW3tcbiAgICAgICAgZW50aXR5OiAnSm9iT3JkZXInXG4gICAgICAgIGZpZWxkOiAnY2F0ZWdvcmllcycsXG4gICAgICAgIG9wZXJhdG9yOiAnZG9lc05vdENvbnRhaW4nLFxuICAgICAgICB2YWx1ZTogJ0hlYWx0aGNhcmUnXG4gICAgICB9XVxuICAgIH1dXG4gIH1cbiAtLT4iXX0=